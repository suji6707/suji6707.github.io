+++
title = 'week6 시행착오, 배운점'
date = 2025-07-07T00:20:22+09:00
draft = true
+++

🟣WEEK6 PR 포인트

* 분산락
분산락과 트랜잭션을 함께 사용.

- 동시 잔액 충전: max retry 10, interval 100
- 동시 좌석 예약: 재시도 아예 하지않고 빠른 실패 처리.

둘다 LOCK TTL은 3초로 했으나 1초로도 충분할듯.
SEAT EXPIRE TTL 5분은 delay 큐에만 적용. 


* 메모리 캐시
둘다 Write-through로 함. 
1. 잘 변하지 않고 자주 읽어야하는 데이터: 애플리케이션 캐시
콘서트 스케줄 조회: concert:id:schedules = []
단순 set.
요소별 업데이트가 잦은것만 hset

2. 

기타 팁 질문:
- TTL 상당히 많은데 constants에 한번에 몰아놔도 되나요? 실무에서 보통 어떤식?
+ TTL 적당한지. 잘 안바뀌는 데이터 1시간..?


🟣🟣 시행착오
왜 50개 전부 실패했을까?
ALREADY RESERVED.
-> 캐시에 분산락이 남아있거나(ttl 안먹은채로)
-> DB에 seat.status가 예약으로 바뀐채 초기화가 안됐거나.
둘 중 하나임.





🟢 MUST
- 좌석예약 k6 돌려봐야함. 분산락 전/후로 같은 스크립트로.
피드백 받은 관점/스펙 그대로 ㄱㄱ.

- HSET은 부분 데이터 수정에 효과적. 
SET은 배열/객체 일부만 변경해도 전체 값을 덮어써야함.
> SET: 스케줄 개수가 적고, 한번에 전체를 읽고 쓸 일이 많을 때
전체 스케줄 데이터를 JSON 배열로 저장하고 한번에 처리
> HSET: 스케줄 개수가 많거나 개별 스케줄 단위 접근/수정/삭제가 필요할 때
각 스케줄을 hash 필드로 저장, 부분 업데이트 및 조회 용이
-> 좌석 N개 남음 정보가 수시로 필요하면.. HSET + 외부캐시
나머지 정보들은 내부캐시.



k6 사용법
```
  thresholds: {
    'http_req_duration{scenario:homepage}': ['p(95)<500'], // 홈페이지 요청의 95%는 500ms 이하여야 함
    'http_req_failed': ['rate<0.01'], // 실패한 HTTP 요청의 비율은 1% 미만이어야 함
    'http_reqs': ['count>100'], // 총 HTTP 요청 수는 100회 이상이어야 함
  },
```
