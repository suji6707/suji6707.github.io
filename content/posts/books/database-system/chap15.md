+++
categories = ['Database']
series = ['Database-System']
tags = ['ë°ì´í„°ë² ì´ìŠ¤']
date = 2024-08-04T22:50:44+09:00
draft = true
+++

# Chap 15. Query Processing

ì¿¼ë¦¬ ì‹¤í–‰ ì—”ì§„ì€ query-evalution planì„ ë°›ì•„ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ì•Œë ¤ì¤€ë‹¤.

#### ì¿¼ë¦¬ í”„ë¡œì„¸ì‹±
ë¹„ìš©ì´ ê°€ì¥ ì ê²Œ ë“œëŠ” ë°©ë²•ìœ¼ë¡œ.
statistical information ì‚¬ìš©. íŠœí”Œ ê°œìˆ˜, í¬ê¸° ë“±.
- ì¿¼ë¦¬ ë¹„ìš© ì¸¡ì •ë°©ë²•
- ê´€ê³„ëŒ€ìˆ˜ í‰ê°€ ì•Œê³ ë¦¬ì¦˜
- ê° operationì„ ì–´ë–»ê²Œ ì•Œê³ ë¦¬ì¦˜ì„ ì¡°í•©í•´ì„œ complete expressoinì„ ë§Œë“œëŠ”ì§€
ê·¸ ë‹¤ìŒì— ì¿¼ë¦¬ ìµœì í™”ë¥¼ ë°°ìš´ë‹¤.

#### ì¿¼ë¦¬ ë¹„ìš© ì¸¡ì •
SSDë¡œ ì¸í•´ IO ë¹„ìš©ì˜ ì§€ë°°ë ¥ì´ ë‚´ë ¤ê°€ê³ , ë”°ë¼ì„œ ì‹¤ì œ ì‹œìŠ¤í…œì—ì„  CPU ë¹„ìš©ì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì§€ë§Œ-
ì§€ê¸ˆì€ ë‹¨ìˆœì„±ì„ ìœ„í•´ ì œì™¸í•˜ê³  ë³´ì.

##### ë””ìŠ¤í¬ ë¹„ìš©
- seeks
- blocks read
- blocks written

ë””ìŠ¤í¬ë¡œí„° ì´ë™í•œ ë¸”ë¡ ê°œìˆ˜(read + write), number of seeksë¥¼ ì‚¬ìš©í•˜ê² ë‹¤.

ì–´ë–¤ ì•Œê³ ë¦¬ì¦˜ì€ ë²„í¼ê³µê°„ì„ ì´ìš©í•´ diskIOë¥¼ ì¤„ì´ê¸°ë„ í•œë‹¤.
worst caseëŠ” ë²„í¼ì— ì–´ë–¤ ë°ì´í„°ë„ ì—†ê³  ìµœì†Œí•œì˜ ë©”ëª¨ë¦¬ë§Œ ê°€ëŠ¥í•œ ê²½ìš°ë‹¤.

#### Selection operation
File scan
ì„ í˜•ê²€ìƒ‰. ê° íŒŒì¼ë¸”ë¡ì„ ìŠ¤ìº”í•˜ê³  ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”ì§€ ë³´ëŠ”.

ì„ í˜•ê²€ìƒ‰ì€ íŒŒì¼ìˆœì„œ, ì¸ë±ìŠ¤ ì—¬ë¶€, ì„ íƒ ì†ì„±ê³¼ ìƒê´€ì—†ì–´ ì–´ë–¤ íŒŒì¼ì—ë„ ì ìš©ëœë‹¤.
ë°”ì´ë„ˆë¦¬ ì„œì¹˜(ë˜ëŠ” í›¨ì”¬ ë‚˜ì€ index serach)ëŠ” ì¸ë±ìŠ¤ ì¡°ê±´ì´ ë§ì„ë•Œë§Œ ê°€ëŠ¥í•˜ë‹¤. 

#### ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•œ Selection
ì¸ë±ìŠ¤ ìŠ¤ìº”
(clustering index, equality on key): í•˜ë‚˜ì˜ ë ˆì½”ë“œë¥¼ ë°˜í™˜. 


---
## ê°€ì •

10ì–µê°œì˜ rowê°€ ìˆëŠ” í…Œì´ë¸”ì—ëŠ” ëª‡ ê°œì˜ ë¸”ë¡ì´ ìˆëŠ”ê°€?
í•œ rowë‹¹ 100 byteë¼ ì¹˜ë©´
1í˜ì´ì§€ 4096/100 byte = 40row per page

10ì–µê°œ row / 40 row = 2400ë§Œê°œ ë¸”ë¡.

Mì€?
16GB ë¨ì— ëª‡ ê°œì˜ ë¸”ë¡ì´ ì˜¬ë¼ê°€ëŠ”ê°€?
16 * 10^9 / 4KB = 4ë°±ë§Œê°œ ë¸”ë¡.

ì „ì²´ br = 24 million
M = 4 million
1ë²ˆì˜ passì— 6ê°œì˜ runì´ ìƒê¹€.
ã…‹ã…‹ ë­”ê°€ í•œë²ˆì— ë˜ëŠ”ë°?

      


---
# ì‹¤ì „ë¬¸ì œ

15.2
```sql
select branch_name 
from branch T
JOIN (
	select assets
	from branch
	where branch_city = "Brooklyn"
) S ON T.assets > S.assets;

// ì‘ìš©
select user_id 
from (
	select user_id, COUNT(keyword_id) AS count from user_tracking_keywords
	group by user_id
) T
JOIN (
	select COUNT(keyword_id) AS count from user_tracking_keywords
	where user_id = 2
) S ON T.count > S.count;
```
```
IN (1,2) ìœ¼ë¡œ í•´ë„ ë‘˜ ì¤‘ í° countì¸ userId 2 ê¸°ì¤€ìœ¼ë¡œ ë” í° íŠœí”Œë§Œ ë‚˜ì˜´.
í™•ì‹¤íˆ Tì˜ í•œ íŠœí”Œë‹¹ Sì˜ ëª¨ë“  íŠœí”Œì„ ë³´ëŠ”ê²Œ ë§ë‚˜ë´„.
ğŸ’ğŸ’ê·¸ë§Œí¼ JOINì€ ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ì—°ì‚°ì´ê¸°ì— inner í…Œì´ë¸”ì¸ Sì˜ í¬ê¸°ë¥¼ ìµœëŒ€í•œ ì¤„ì—¬ì„œ ê°€ì ¸ê°€ì•¼í•¨.
```

ì´ ê´€ê³„ëŒ€ìˆ˜ í‘œí˜„ì‹ì€ ì£¼ì–´ì§„ SQL ì¿¼ë¦¬ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. ê° ê¸°í˜¸ì˜ ì˜ë¯¸ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

- \(\Pi\): í”„ë¡œì ì…˜ ì—°ì‚°ìë¡œ, í•„ìš”í•œ ì†ì„±ë§Œ ì„ íƒí•©ë‹ˆë‹¤. (select)
- \(\sigma\): ì„ íƒ ì—°ì‚°ìë¡œ, ì¡°ê±´ì— ë§ëŠ” íŠœí”Œë§Œ ì„ íƒí•©ë‹ˆë‹¤. (where)
- \(\rho\): ë¦¬ë„¤ì´ë° ì—°ì‚°ìë¡œ, í…Œì´ë¸”ì´ë‚˜ ì†ì„±ì˜ ì´ë¦„ì„ ë³€ê²½í•©ë‹ˆë‹¤.
- \(\Join\): ì¡°ì¸ ì—°ì‚°ìë¡œ, ë‘ í…Œì´ë¸”ì„ ê²°í•©í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ì„¸íƒ€ ì¡°ì¸(\(\Join_{\theta}\))ì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ì¡°ê±´ì— ë§ëŠ” íŠœí”Œì„ ê²°í•©í•©ë‹ˆë‹¤.

ì´ í‘œí˜„ì‹ì€ ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ê³„ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤:

1. \(\rho_T(branch)\)ì™€ \(\rho_S(branch)\): ë‘ í…Œì´ë¸”ì„ ê°ê° Tì™€ Së¡œ ë¦¬ë„¤ë°í•©ë‹ˆë‹¤.
2. \(\Pi_{branch\_name, assets}(\rho_T(branch))\): T í…Œì´ë¸”ì—ì„œ branch_nameê³¼ assets ì†ì„±ë§Œ ì„ íƒí•©ë‹ˆë‹¤.
3. \(\sigma_{(branch\_city = 'Brooklyn')}(\rho_S(branch))\): S í…Œì´ë¸”ì—ì„œ branch_cityê°€ 'Brooklyn'ì¸ íŠœí”Œë§Œ ì„ íƒí•©ë‹ˆë‹¤.
4. \(\Pi_{assets}(\ldots)\): S í…Œì´ë¸”ì—ì„œ assets ì†ì„±ë§Œ ì„ íƒí•©ë‹ˆë‹¤.
5. \(\Join_{T.assets > S.assets}(\ldots)\): Tì™€ S í…Œì´ë¸”ì„ assets ì†ì„±ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¸íƒ€ ì¡°ì¸í•©ë‹ˆë‹¤.
6. \(\Pi_{T.branch\_name}(\ldots)\): ìµœì¢… ê²°ê³¼ì—ì„œ T í…Œì´ë¸”ì˜ branch_name ì†ì„±ë§Œ ì„ íƒí•©ë‹ˆë‹¤.

ì´ ê³¼ì •ì€ ë¶ˆí•„ìš”í•œ ë°ì´í„°ë¥¼ ì¤„ì´ê³ , í•„ìš”í•œ ë°ì´í„°ë§Œì„ íš¨ìœ¨ì ìœ¼ë¡œ ì¶”ì¶œí•˜ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤.

---
7.
```js
class IndexedNLJoin {
    Iterator outer;
    Iterator inner;
    Tuple t_r; // current outer tuple
    boolean done; // flag for end of outer scan

    public void open() {
        outer.open();
        inner.open();
        done = false;
        
        if (outer.next() != null) {
            t_r = outer.getCurrentTuple();
        } else {
            done = true;
        }
    }

    public boolean next() {
        while (!done) {
            if (inner.next(t_r.getJoinAttributes()) != null) {
                Tuple t_s = inner.getCurrentTuple();
                // Join t_r and t_s and place in output buffer
                outputBuffer.add(concatenate(t_r, t_s));
                return true;
            } else {
                if (outer.next() != null) {
                    t_r = outer.getCurrentTuple();
                    inner.rewind();
                } else {
                    done = true;
                }
            }
        }
        return false;
    }

    private Tuple concatenate(Tuple t_r, Tuple t_s) {
        // Implement tuple concatenation logic
        return new Tuple(t_r, t_s);
    }
}
```


ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì˜ˆì‹œë¡œ Indexed Nested Loop Joinì„ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤:

```sql
-- ì˜ˆì‹œ í…Œì´ë¸”
Employees (emp_id, name, dept_id)  -- outer relation
Departments (dept_id, dept_name)   -- inner relation with index on dept_id
```

ì‹¤í–‰ ê³¼ì •:
```java
// 1. ì´ˆê¸°í™” (open())
IndexedNLJoin join = new IndexedNLJoin();
join.open();
    outer.open();  // Employees í…Œì´ë¸” ìŠ¤ìº” ì‹œì‘
    inner.open();  // Departments ì¸ë±ìŠ¤ ì¤€ë¹„
    // emp_id=1, name="John", dept_id=10 ì²« ë²ˆì§¸ íŠœí”Œ ì½ìŒ

// 2. ì¡°ì¸ ì‹¤í–‰ (next())
while (join.next()) {
    // First iteration:
    // outer tuple: (1, "John", 10)
    inner.next(10)  // dept_id=10ì¸ Department ê²€ìƒ‰
        // ì¸ë±ìŠ¤ ì‚¬ìš©í•˜ì—¬ dept_id=10ì¸ íŠœí”Œ ì°¾ìŒ
        // (10, "IT") ë°œê²¬
        // ê²°ê³¼: (1, "John", 10, "IT")
    
    // Second iteration:
    // outer tuple: (2, "Jane", 20)
    inner.next(20)  // dept_id=20ì¸ Department ê²€ìƒ‰
        // (20, "HR") ë°œê²¬
        // ê²°ê³¼: (2, "Jane", 20, "HR")
    
    // ê³„ì†...
}
```

ì‹¤ì œ ì‹¤í–‰ ê²°ê³¼:
```sql
-- ì…ë ¥ ë°ì´í„°
Employees:
emp_id  name    dept_id
1       John    10
2       Jane    20
3       Bob     10

Departments:
dept_id dept_name
10      IT
20      HR

-- ì¡°ì¸ ê²°ê³¼
emp_id  name    dept_id  dept_name
1       John    10       IT
2       Jane    20       HR
3       Bob     10       IT
```

ì£¼ìš” íŠ¹ì§•:
1. Departments í…Œì´ë¸”ì˜ dept_idì— ì¸ë±ìŠ¤ê°€ ìˆì–´ ë¹ ë¥¸ ê²€ìƒ‰ ê°€ëŠ¥
2. ê° Employee ë ˆì½”ë“œì— ëŒ€í•´ ì¸ë±ìŠ¤ë¥¼ í†µí•´ ë§¤ì¹­ë˜ëŠ” Departmentë¥¼ ì°¾ìŒ
3. ì¸ë±ìŠ¤ ê²€ìƒ‰ìœ¼ë¡œ ì „ì²´ í…Œì´ë¸” ìŠ¤ìº” íšŒí”¼
4. íŠ¹íˆ inner relationì´ í° ê²½ìš° íš¨ìœ¨ì 


---
8.

ë°ì´í„°ë² ì´ìŠ¤ì—ì„œì˜ ë‚˜ëˆ—ì…ˆ ì—°ì‚°ì€ íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” íŠœí”Œì„ ì°¾ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤. ì£¼ë¡œ ë‘ ê°œì˜ ê´€ê³„ \( r \)ê³¼ \( s \)ê°€ ìˆì„ ë•Œ, \( r \div s \)ëŠ” \( r \)ì˜ \( T \) ì†ì„± ê°’ ì¤‘ \( s \)ì˜ ëª¨ë“  \( S \) ê°’ì„ í¬í•¨í•˜ëŠ” \( T \) ê°’ì„ ì°¾ëŠ” ì—°ì‚°ì…ë‹ˆë‹¤.

### ì˜ˆì‹œ

#### ê´€ê³„ \( r \)
| T | S |
|---|---|
| A | 1 |
| A | 2 |
| B | 1 |
| B | 2 |
| C | 1 |

#### ê´€ê³„ \( s \)
| S |
|---|
| 1 |
| 2 |

### ë‚˜ëˆ—ì…ˆ ì—°ì‚° \( r \div s \)

- **ëª©í‘œ**: \( s \)ì˜ ëª¨ë“  \( S \) ê°’ì„ í¬í•¨í•˜ëŠ” \( T \) ê°’ì„ ì°¾ê¸°.
- **ê²°ê³¼**: \( T = A, B \)

#### ì„¤ëª…
- \( T = A \)ëŠ” \( S = 1, 2 \)ë¥¼ ëª¨ë‘ í¬í•¨í•˜ë¯€ë¡œ ê²°ê³¼ì— í¬í•¨ë©ë‹ˆë‹¤.
- \( T = B \)ë„ \( S = 1, 2 \)ë¥¼ ëª¨ë‘ í¬í•¨í•˜ë¯€ë¡œ ê²°ê³¼ì— í¬í•¨ë©ë‹ˆë‹¤.
- \( T = C \)ëŠ” \( S = 2 \)ë¥¼ í¬í•¨í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê²°ê³¼ì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ ë‚˜ëˆ—ì…ˆ ì—°ì‚°ì€ íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” \( T \) ê°’ì„ ì°¾ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.

---
ì´ ë¬¸ì œëŠ” ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì—ì„œì˜ ë‚˜ëˆ—ì…ˆ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ì •ë ¬ ê¸°ë°˜ ë° í•´ì‹œ ê¸°ë°˜ ì•Œê³ ë¦¬ì¦˜ì„ ì„¤ê³„í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. 

### ì •ë ¬ ê¸°ë°˜ ì•Œê³ ë¦¬ì¦˜

1. **ì •ë ¬**: 
   - ê´€ê³„ \( r(T \cup S) \)ì™€ \( s(S) \)ë¥¼ ê°ê° ì •ë ¬í•©ë‹ˆë‹¤. \( r \)ëŠ” \( (T, S) \)ë¡œ ì •ë ¬í•˜ê³ , \( s \)ëŠ” \( S \)ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.

2. **ìŠ¤ìº” ë° ë¹„êµ**:
   - \( r \)ë¥¼ ìŠ¤ìº”í•˜ë©´ì„œ ì²« ë²ˆì§¸ íŠœí”Œì˜ \( T \) ì†ì„± ê°’ì„ í™•ì¸í•©ë‹ˆë‹¤. ë™ì¼í•œ \( T \) ê°’ì„ ê°€ì§„ íŠœí”Œë“¤ì„ ëª¨ë‘ ìŠ¤ìº”í•©ë‹ˆë‹¤.
   - ë™ì‹œì— \( s \)ë¥¼ ìŠ¤ìº”í•˜ì—¬ \( r \)ì˜ \( S \) ì†ì„± ê°’ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì´ëŠ” ë³‘í•© ì¡°ì¸ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤.
   - ëª¨ë“  \( s \)ì˜ íŠœí”Œì´ \( r \)ì˜ \( S \) ì†ì„±ìœ¼ë¡œ ì¡´ì¬í•˜ë©´ í•´ë‹¹ \( T \) ê°’ì„ ì¶œë ¥í•©ë‹ˆë‹¤.

3. **ë””ìŠ¤í¬ ì ‘ê·¼**:
   - ì •ë ¬ í›„ ë””ìŠ¤í¬ ì ‘ê·¼ íšŸìˆ˜ëŠ” \( |r| + N \times |s| \)ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œ \( N \)ì€ \( r \)ì˜ ì„œë¡œ ë‹¤ë¥¸ \( T \) ê°’ì˜ ê°œìˆ˜ì…ë‹ˆë‹¤.

### í•´ì‹œ ê¸°ë°˜ ì•Œê³ ë¦¬ì¦˜

1. **ë©”ëª¨ë¦¬ ë‚´ íŒŒí‹°ì…˜**:
   - \( r \)ë¥¼ \( T \) ì†ì„±ìœ¼ë¡œ íŒŒí‹°ì…˜í•˜ì—¬ ê° íŒŒí‹°ì…˜ì´ ë©”ëª¨ë¦¬ì— ì í•©í•˜ë„ë¡ í•©ë‹ˆë‹¤.

2. **í•´ì‹œ í…Œì´ë¸” ìƒì„±**:
   - ê° íŒŒí‹°ì…˜ì„ ì²˜ë¦¬í•˜ë©´ì„œ ëª¨ë“  ì„œë¡œ ë‹¤ë¥¸ \( T \) ê°’ì„ ë³„ë„ì˜ í•´ì‹œ í…Œì´ë¸”ì— ìˆ˜ì§‘í•©ë‹ˆë‹¤.

3. **ê²€ì‚¬ ë° ì¶œë ¥**:
   - ê° \( T \) ê°’ì— ëŒ€í•´, \( s \)ì˜ ê° ê°’ê³¼ í•´ì‹œ í…Œì´ë¸”ì„ ë¹„êµí•©ë‹ˆë‹¤.
   - ê°’ì´ ì—†ìœ¼ë©´ í•´ë‹¹ \( T \) ê°’ì„ ë²„ë¦¬ê³ , ìˆìœ¼ë©´ ì¶œë ¥í•©ë‹ˆë‹¤.

ì´ ì•Œê³ ë¦¬ì¦˜ë“¤ì€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë‚˜ëˆ—ì…ˆ ì—°ì‚°ì„ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ë°©ë²•ì„ ì œì‹œí•©ë‹ˆë‹¤. ì •ë ¬ ê¸°ë°˜ ì•Œê³ ë¦¬ì¦˜ì€ ì •ë ¬ê³¼ ë³‘í•©ì„ í†µí•´, í•´ì‹œ ê¸°ë°˜ ì•Œê³ ë¦¬ì€ í•´ì‹œ í…Œì´ë¸”ì„ í†µí•´ ì—°ì‚°ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

---