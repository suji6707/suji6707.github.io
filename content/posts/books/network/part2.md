+++
title = '스터디 2회차'
date = 2024-05-07T00:20:22+09:00
draft = true
+++
## 스위치와 라우터
라우터만 알면 됨.
스태틱 라우팅. 

---
ALB는 클라-서버 를 가로챔.
-> XFF헤더

NLB는 L4이므로 XFF 헤더 인식 X.

하나의 NLB로 HTTP

---
### Q&A
#### 글로벌 L4
1. gslb 글로벌 로드밸런서가 따로 있음
지연이나 latency 기준이라면, gslb에 물어봄
서로 IP가 다 다른 상태에서.
2. 구글이나 KT DNS 
동일한 IP를 글로벌에 여러곳에 들고있음.
애니캐스트로 찔러보면 나랑 가까운 곳으로 보내주는 것.
(IP 하나를 애니캐스트로.)

일단 빠른 경로.
1GB 회선 등 더 큰 곳으로 보내거나.
근데 BGP는 보통 정책 기반.

*BGP와 VPN 간의 이중화?
클라우드- 온프렘 연결시
전용선 또는 VPN. 
VPN은 기본적으로 인터넷 회선이라 비용이 저렴. 속도베이스 과금이고.

AWS 기본 공고 가이드는 양쪽 다 이중화 -> 4개 회선..
전용선이 메인, VPN은 백업. 


*고정IP를 쓸 때는 NLB를 씀.
KT에서 티맵은 네트워크 비용 안매긴다고 할때- 
거의 물리박스 장비.
ALB는 vlan?같은거고.

ALB는 클라이언트 IP 알수없고
NLB는 클라이언트를 알아볼 수 있는데.
프록시 프로토콜 설정하면 NLB를 쓰고 클라이언트 IP가 숨겨지는 상황에서도 IP를 알 수 있다.
-> IP기반으로 막는다는건.?

#### 네이버로 접속하는 과정 (면접)
- IP 주소
- 스위치(L2)
- 게이트웨이(L3)

💎 스태틱 라우팅은 중요함
어느목적지로 가라고 직접 셋팅하는거라서

VPN - 내부 정책을 위해 전부 센터로 올린다?

집에서 메일보내는데 회사 VPN 켜놓으면 거기서 막히는 경우도 있었음.

🍎 route print -> 라우팅 테이블
인터넷으로 가는 0.0.0.0은 어떤 게이트웨이, 인터페이스로 보내라-
나머지는 전부 연결된 네트워크들.

VPN 연결하면 0.0.0.0이 공유기 IP가 아니라 회사 VPN 터널이 잡힘.
-> 모든 트래픽이 회사 VPN으로 가버리는.
이때 내가 임의로 라우팅 테이블을 추가하면 됨!

🍋 `route add 10.0.0.0 mask 255.255.255.0 gw 10.0.0.1`
- 10.0.0.0: 목적지 네트워크 주소
- mask 255.255.255.0: 서브넷 마스크로, 이 경우에는 /24 서브넷을 지정하며, 네트워크 부분을 10.0.0.이라고 지정하고, 호스트 부분을 .1부터 .254까지로 지정
- gw 10.0.0.1: 게이트웨이 또는 다음 홉의 주소입니다. 이 주소는 트래픽이 해당 서브넷으로 이동할 때 거쳐야 할 중간 장치(라우터)의 IP 주소
- 이 명령을 사용하여 라우팅 테이블에 경로를 추가하면, 시스템은 IP 주소가 10.0.0.1부터 10.0.0.254 사이인 목적지로 가는 모든 패킷을 10.0.0.1을 게이트웨이로 사용하여 전달합니다. 
- 즉, 이 명령은 10.0.0.0/24 네트워크로 가는 모든 트래픽을 특정 라우터(10.0.0.1)를 통해 라우팅하도록 설정합니다. 이는 특정 네트워크 세그먼트에 대한 트래픽 흐름을 제어하거나, 다중 네트워크 환경에서 특정 경로를 지정하는 데 유용할 수 있습니다.

이걸 서버쪽에서 해야하는 경우도 있음.
🍎 클라우드 라우팅은 직접 스태틱 라우팅으로 설정해야.
**목적지 IP와, 여기로 가려면 어디로 가야한다** - 세트로.

퍼블릭 서브넷 라우팅 테이블 설정:
172.68.?은 local,
0.0.0.0은 IGW로.

🍋 Local
- Destination default: 모든 외부 트래픽을 위한 기본 경로
	- 0.0.0.0 에 해당.
- Gateway 192.168.45.1: 이 트래픽이 인터넷으로 나가기 위해 거쳐야 하는 라우터의 IP 주소. 트래픽이 인터넷으로 나갈 때 사용되는 로컬 네트워크의 출구 또는 "게이트웨이"를 의미
- Flags: 
U는 라우트가 사용 중임을 나타냅니다.
G는 게이트웨이를 통해 전송되어야 함을 의미합니다.
S는 이 라우트가 정적 라우트임을 나타냅니다 (시스템이나 관리자에 의해 설정됨).
- Netif: en0는 이 라우트가 네트워크 인터페이스 en0를 사용한다는 것을 의미합니다, 이는 일반적으로 이더넷 인터페이스 또는 Wi-Fi 인터페이스

```
❯ netstat -rn                                                                ─╯
Routing tables

Internet:
Destination        Gateway            Flags               Netif Expire
default            192.168.45.1       UGScg                 en0       
127                127.0.0.1          UCS                   lo0       
```
---

라우팅은 목적지 IP만 알고있음.
근데 서버가 아닌 너머의 L3로 보내고있었던 것..

모든 경로에서 양방향에 대한 목적지를 알고있어야 함..
A에서 목적지 20으로 가려면 B로 가야한다는 것만 알았지
응답이 어디까지 가는지도 봐야. 

🍎 trace hope를 찍어보면 에러의 구간을 좁힐 수 있음.
다, 라.
다는 보냈는데 라가 라우팅을 못받았거나
다에서 라우팅을 안보냈거나.

Q. 라우터는 왜 목적지를 알 필요 없지?


클라우드에선 라우팅만 잘 해도 됨.
스위치만 공부하면 오히려 헷갈림. 
클라우드는 브로드캐스트가 안돼서 모든 전제가 깨진다고 함.

PC, 서버 다 7계층인데.
로드밸런서, 방화벽은 L4나 L7으로 동작하지만
세션테이블을 갖고 있음. - 이건 애플리케이션도 마찬가지.
🍎 이렇게 세션테이블이 엮여있으면 세션 맞는것끼리 **타임아웃을 맞추는 게 좋음**.
한쪽에서만 타임아웃을 죽여버리고 다른쪽에선 물고있으면 통신이 됐다안됐다 하는것처럼 보여서 더 힘듦.

장비 옛날 모델 - 최근 모델 - 
세션 타임아웃을 다르게 갖고가니까 문제가 발생한다고 함.


목적지 S로 가는 애들은 80 포트를 오픈해줘라.
-> 클라로 보내주는데
출발지를 보낼 때는 랜덤 포트기때문에 아무거나 잡히겠지만(20000)
응답을 할 때는 목적지가 20000이 됨.
- 방화벽을 다 넣을 순 없으니 응답은 전부 허용. 정책이 아니라. 세션테이블만 보고. 

그런데 둘다 액티브로 쓰는 경우에는
동기화시키는데.
응답임에도 세션테이블이 없으면 드랍됨.
세션장비들은 비대칭 경로가 되면 통신이 안되는게 특징임.

세션장비들로 정책을 허용할 때 L4가 같은 것끼리. (세션테이블값을 조정)
안그러면 맺어진게 아니라고 여기거나..

🟣Q. 세션테이블이 뭐임??

🟣 L4 라우팅 중요.

---
그래서 라우팅은 IP 기반으로 보내주고, ARP로 특정 디바이스로 보내준다?





