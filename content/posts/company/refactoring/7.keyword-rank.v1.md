+++
title = 'í‚¤ì›Œë“œ ë­í‚¹ì¶”ì '
date = 2024-05-07T00:20:22+09:00
draft = true
+++
## í‚¤ì›Œë“œ ë­í‚¹ì¶”ì 

### TODO 2

- í‚¤ì›Œë“œ ê¶Œí•œì²´í¬ ë„£ê¸° 
1. GET ì¶”ì  í‚¤ì›Œë“œ ì¶”ê°€ ê°€ëŠ¥ ê°œìˆ˜ë¥¼ ë¦¬í„´ 

user_tracking_keywords ì–´ëŒ‘í„°ë¡œ ì „ë¶€ ì˜®ê¸°ê¸°!!
- updateKeywordsí•  ë•Œ 
- loadKeywords

SELECT distinct tracking_product_id, keyword_id FROM user_tracking_keywords WHERE user_id IN
-> ì ê¹. ì´ê²ƒë„ ë„ë©”ì¸ì´ ìˆì–´ì•¼ í•˜ë‚˜?
ë„ë©”ì¸ìœ¼ë¡œ ë‘ì§€ ë§ì. 
- ê·¸ëŸ¼ update keyword usecaseì—ì„œ ì–´ëŠ ì‹œì ì— user tracking keywordë¥¼ ì €ì¥í•  ê²ƒì¸ê°€?

### TODO
- trackRealTimeRank: ì˜¤ëŠ˜ì KeywordRank ìˆëŠ”ì§€ ì²´í¬í•˜ëŠ” ë¡œì§ ì¶”ê°€
	- checkAndCrawlRankì—ì„œ í•œë²ˆë” return RankingKeywordProduct.selectLast(keywordId, tpId) ì²´í¬í•˜ê³  ìˆìœ¼ë©´ selectAllë¡œ ë³´ë‚´ì£¼ëŠ”ë°..
	- ëŒ€ì²´ ì™œ ë³´ë‚´ëŠ”ê±°ì„?
- í‚¤ì›Œë“œë­í‚¹ selectAll ë¦¬í„´í•˜ëŠ” ë¶€ë¶„. ì™œì§€?
	- ì´ë¯¸ res.setResult(true)ë¡œ ë‚˜ê°”ëŠ”ë°..
- ë ˆê±°ì‹œ ì„œë²„ fast_statì— ìš”ì²­í•˜ëŠ” ë¶€ë¶„.


- adRank í™”ë©´ìƒ ì•ˆë³´ì„!
	- í‚¤ì›Œë“œì— ëŒ€í•œ ì¼ê°„ ë­í‚¹ ì¶”ì  listì— ìˆì–´ì•¼ í•˜ëŠ”ë°..

- ë­í‚¹ ìˆœìœ„ ì¡°íšŒ(ë‚´ìƒí’ˆ vs ë¹„êµìƒí’ˆ, 8ì¼ì¹˜)
	- RankingKeywordProduct.listDurationV2(

- new keywordsì— ëŒ€í•œ stat ê°€ì ¸ì˜¤ê¸°
	- KeywordStatsService.getKeywordResultFromCrawler(keyword)
	- ë§Œì•½ ìƒˆ ë‚ ì§œë¶„ statë§Œ ì €ì¥í•˜ëŠ”ê±°ë¼ë©´?
	- ë¦¬í„´ì„ í•˜ëŠ” ë¶€ë¶„ì€ ì‚¬ì‹¤ìƒ ë¬´ì‹œëœê±°ê³ ? (ì´ë¯¸ res.setResult)
	- ê·¸ëŸ¼ ì‹¤ì œë¡œ new keywords statì„ ë³´ë‚´ì£¼ëŠ” ë¶€ë¶„ì€? ì–´ë””ì„œ ì“°ì§€?
		- ì ì–´ë„ trakcing keywordsìª½ APIëŠ” ì•„ë‹Œ ê²ƒ ê°™ìŒ

	- KeywordStatsService.getKeywordResultFromCrawler(keyword); í•˜ê³  ëë‚´ë¼ëŠ” ê²ƒ

### TEST
í…ŒìŠ¤íŠ¸ ëª©ì .
í‚¤ì›Œë“œ ìˆœìœ„ê°€ ë‚´ìƒí’ˆê³¼ ë¹„êµìƒí’ˆì— ëŒ€í•´ - ëª¨ë“  new keywordsì— ëŒ€í•´ ì €ì¥ë˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
- ì£¼ì…í•´ì•¼ í•  ì„œë¹„ìŠ¤
	- naver scrape: productIdsë¥¼ ì„ì˜ë¡œ ì¤€ë‹¤ (string)


### ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸
- AuthContextServiceì—ì„œ ìœ ì €ì •ë³´ ì½ì–´ì˜¬ ìˆ˜ ìˆë„ë¡
ğŸ‹ í¬ìŠ¤íŠ¸ë§¨ í—¤ë” ì„¤ì •í•˜ê¸°


í˜„ì¬.
update
```typescript
    hihi loaded tracking Tracking {
      _id: ID { _value: 187 },
      _createdAt: 2024-03-13T08:38:35.000Z,
      _updatedAt: 2024-05-07T04:31:46.000Z,
      _deletedAt: null,
      _userId: 2,
      _product: Product {
        _id: ID { _value: 156 },
        _createdAt: 2024-03-13T08:38:35.000Z,
        _updatedAt: 2024-03-13T08:38:35.000Z,
        _deletedAt: null,
        _url: 'https://smartstore.naver.com/hi_265mm/products/5318510427',
        _metadata: {
          nvMid: '82863002994',
          mallPid: '5318510427',
          type: 0,
          channelUid: '2sWDwIGiKYUutRVdiYOMr',
          title: '[êµ­ë‚´ë°°ì†¡] ë©í¬ë¡œìš° ê²€í° ë²”ê³ ë˜ DD1391-100',
          image: 'https://shop-phinf.pstatic.net/20210107_10/1609991937095qXbxS_JPEG/11127770374730465_286269273.jpg?type=m510',
          storeId: 500287943,
          regDate: null,
          initialCrawled: 0
        }
      },
      _keywords: [
        Keyword {
          _id: [ID],
          _createdAt: 2023-03-14T04:41:52.000Z,
          _updatedAt: 2023-03-14T04:41:52.000Z,
          _deletedAt: null,
          _keyword: 'ì§‘ë“¤ì´ì„ ë¬¼'
        },
        Keyword {
          _id: [ID],
          _createdAt: 2023-10-30T16:06:43.000Z,
          _updatedAt: 2023-10-30T16:06:43.000Z,
          _deletedAt: null,
          _keyword: 'ì„ ë¬¼ìš©ë¬´ë“œë“±'
        },
        Keyword {
          _id: [ID],
          _createdAt: 2024-05-11T16:17:12.000Z,
          _updatedAt: 2024-05-11T16:21:01.000Z,
          _deletedAt: null,
          _keyword: 'LEDë¬´ë“œë“±'
        }
      ],
      _catalogs: []
    }
```

---
### ì»¨íŠ¸ë¡¤ëŸ¬


/v2/tracking/keyword/addable/201

/v2/tracking/keyword: ë­í‚¹ ì¶”ì  í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ api
- tracking_id 201
- keywords [ì´ì¦ˆë„¤ì´ì²˜, ì‹íƒì˜ì]


/v2/tracking/keyword/log
- Permission Logicì—ì„œ keyword Limitì„ êµ¬í•œë‹¤
- user_tracking_keywords ì—ì„œ ì¶”ì ì¤‘ì¸ ê°œìˆ˜ë¥¼ êµ¬í•œë‹¤
- ë‘˜ ì¤‘ ì‘ì€ ê°’ìœ¼ë¡œ ë°˜í™˜í•œë‹¤


ğŸ’ ì¡°íšŒ
1. í‚¤ì›Œë“œì— ëŒ€í•œ ì¼ê°„ ë­í‚¹ ì¶”ì  list
v2/tracking/keyword/rank/:trackingId/:keywordId

2. ìƒí’ˆ ì¢…í•©ì •ë³´(í‘œ): /v2/tracking/product/general/:trackingProductId
3. ì‹œê³„ì—´ ì •ë³´(ê·¸ë˜í”„): v2/tracking/product/graph/:trackingProductId?startDate=&endDate=


ìœ ìŠ¤ì¼€ì´ìŠ¤ -> ì»¨íŠ¸ë¡¤ëŸ¬
ì„œë¹„ìŠ¤ -> ì‹¤ì œ ë™ì‘ 


### ìœ ìŠ¤ì¼€ì´ìŠ¤
1. Update Keywords UseCase: í‚¤ì›Œë“œë¥¼ ë“±ë¡í•œë‹¤
input: keywordStr: string[], trackingId => DTO
output: new keywords: Keyword[]
user_tracking_keywords 

+ update Keywords()
ctx.userId

1. Update Keywords Service: í‚¤ì›Œë“œë¥¼ ë“±ë¡í•œë‹¤
input: keywordStr: string[], userId,trackingId
output: new keywords: Keyword[]


2. Rank Keyword Service: ë­í‚¹ì„ ì¶”ì í•œë‹¤
input: new keywords: Keyword[], ìƒí’ˆ: tpId
output: ì„±ê³µì—¬ë¶€
+ rank keyword()
	- outport
	- checkMallPid

3. Rank Catalog Service: ê¸°ì¡´ ì¹´íƒˆë¡œê·¸ ë“±ë¡ì— ëŒ€í•œ ì¶”ì  ì‹œì‘
input: userId, new keywords: Keyword[], tpId
output: ì„±ê³µì—¬ë¶€
+ rank catalog()

4. Get Keyword Stats Service: ìƒˆ í‚¤ì›Œë“œì— ëŒ€í•œ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ (keyword_monthly_search ë“±)
input: Keyword[]
output: ì„±ê³µì—¬ë¶€
(ë¹„ê³ ) Outportë¡œ êµ¬í˜„. ê¸°ì¡´ ì„œë²„ì— ìš”ì²­
+ fetch keyword stats()




---
1. í‚¤ì›Œë“œë¥¼ ë“±ë¡í•œë‹¤.
- user, trackingId ê¸°ë°˜ìœ¼ë¡œ tpIdë¥¼ ê°€ì ¸ì˜¨ í›„
- addable ì²´í¬. 
- keywordsë¥¼ ê°€ëŠ¥ ê°œìˆ˜ë§Œí¼ ì˜ë¼ì„œ
	- ê°€ëŠ¥ ê°œìˆ˜ê°€ 0ì´ë©´ user_tracking_keywordsì—ì„œ í•´ë‹¹ tpIdë¥¼ ì§€ìš´ë‹¤
	- ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì¶”ê°€
		- replaceKeywordsì— insertAndGetí•œ í‚¤ì›Œë“œë¥¼ ë„£ëŠ”ë‹¤
		- current: user_tracking_keywords ì—ì„œ ìœ ì €ê°€ í•´ë‹¹ ìƒí’ˆì— ëŒ€í•´ ì¶”ì í•˜ëŠ” keyword idë¥¼ ê°€ì ¸ì˜¨ë‹¤
		- replaceì— ìˆëŠ”ë° currentì— ì—†ìœ¼ë©´ new keywordsë¡œ ì¶”ì í•œë‹¤.
		- currentì—ëŠ” ìˆëŠ”ë° replaceì— ì—†ìœ¼ë©´ ì‚­ì œí•œë‹¤
- ìƒˆë¡œìš´ í‚¤ì›Œë“œ
	- RankingTrackingKeyword ì— í•´ë‹¹ keywordIdê°€ ìˆìœ¼ë©´ true, ì—†ìœ¼ë©´ ì‚½ì…
	- user_tracking_keywords ì— ìœ ì €, ìƒí’ˆid, í‚¤ì›Œë“œidë¥¼ ë„£ëŠ”ë‹¤.
- ì‚­ì œ ë°©ë²•
	- user_tracking_keywords, UserDailyTrackingAlarms ì—ì„œ ì‚­ì œ


- ğŸ’ ìƒˆ í‚¤ì›Œë“œì— ëŒ€í•´ ì‹¤ì‹œê°„ ë­í‚¹ ì¶”ì 
	- trackRealTimeRank
		- ranking_keywords_products ì—ì„œ ì˜¤ëŠ˜ì 00ì‹œ ì´í›„ ë­í‚¹ì´ ì—†ëŠ” keywordIdsë§Œ í¬ë¡¤ë§ ì‹œì‘
		- checkAndCrawlRank
- checkAndCrawlRank ë¡œì§
	- ranking_keywords_products ì—ì„œ í•´ë‹¹ ìƒí’ˆ-í‚¤ì›Œë“œë¡œ ìµœê·¼ ê¸°ë¡ì„ ê°€ì ¸ì˜¨ë‹¤
	- lastCrawl ë‚ ì§œê°€ ì˜¤ëŠ˜ê³¼ ê°™ìœ¼ë©´ í¬ë¡¤ë§ í•˜ì§€ì•Šê³ 
	- ë‹¤ë¥´ë©´ ìµœê·¼ê¹Œì§€ ëª¨ë“ ì¼ì ë­í‚¹ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ í›„
	- crawlRankViaAPIë¥¼ ì‹¤í–‰í•œë‹¤. -> try catch ë¸”ë¡ì— ì¡íˆë©´ í•œ ë²ˆ ë” ì‹œë„í•œë‹¤.
- crawlRankViaAPI ë¡œì§
	- crawlTrackingProductsWithNvmid: ì¶”ì ìƒí’ˆì˜ nvmid, nvCatalogId(ë¬¶ìŒìƒí’ˆ) ì •ë³´ë¥¼ ê°€ì ¸ì˜´
	- requestAndCrawlShopPageViaAPI: 10í˜ì´ì§€ê¹Œì§€ ì˜¤í”ˆ APIë¡œ ëª¨ë“  productIdë¥¼ ë°˜í™˜
	- 1000ê°œì˜ productIdsì— ëŒ€í•´ checkNvmids
- checkNvmids ë¡œì§
	- 
- insertRestAll : ë‚¨ì€ tpList rankë¥¼ 0 ë„£ê¸°


(ì°¸ê³ )
- review_hash = nvMid
- getProductDetailInfo
	- catalog_id: data.epInfo?.matchingModelId, // ë¬¶ìŒìƒí’ˆ ì—¬ë¶€
	- nvCatalogId ë¡œ ë¦¬í„´

---
2. ë¡œê·¸ë¥¼ ê¸°ë¡í•œë‹¤

---
ğŸ’ ë°°ì¹˜ - ranking_tracking.js

### ë„ë©”ì¸
user_tracking_keywords
- user, tpId, keywordId, order

ranking_keywords_products
- keywordId, tpId, rank, tie, tie_rank

ranking_tracking_keywords
- id, keywordId

user_tracking_alarms
- user, tpId, keywordId > ëˆ„ê°€ ì–´ë–¤ ìƒí’ˆì— ëŒ€í•´ ì–´ë–¤ í‚¤ì›Œë“œë¥¼ ì¶”ì í•˜ëŠ”ì§€.
orderë§Œ ì—†ì„ ë¿.. UTKì™€ ë™ì¼??

---
### ğŸŸ£ ì™¸ë˜í‚¤ ì—†ì´ relation ë„ë©”ì¸ ë“¤ê³ ì˜¤ëŠ” ë°©ë²•
ì‚¬ì‹¤ ë‘ ê°€ì§€ ë°©ë²•ì´ ìˆìŒ.
- toDomain í•  ë•Œë¶€í„° ë„ë©”ì¸ì„ ë„£ì–´ë†“ëŠ” ë°©ë²•ê³¼ (entityì— í•„ë“œì¶”ê°€)
- í•„ìš”í•  ë•Œ loadKeywordsë¡œ keywords í•„ë“œì— ë„ë©”ì¸ì„ ë„£ëŠ” ë°©ë²•

ì‚¬ì‹¤ Trackingì´ë¼ëŠ” ê±´ ì¼ì¢…ì˜ ë§¤í•‘ í…Œì´ë¸” ì—­í• ì´ê¸° ë•Œë¬¸ì—
productëŠ” ì²˜ìŒë¶€í„° ë„ë©”ì¸ í•„ë“œë¥¼ ë“¤ê³ ìˆëŠ”ê²Œ ë‚«ë‹¤ê³  ìƒê°í–ˆê³ 
keywords, catalogsëŠ” í•„ìš”í• ë•Œë§Œ ì“°ë„ë¡.
-> ê·¼ë° ê²°ê³¼ì ìœ¼ë¡œëŠ” getTracking()ì—ì„œ ë‹¤ ë„£ê²Œ í•´ë‘”ì§€ë¼.. ê°™ì€ë“¯.

--
ì–´ëŒ‘í„°ê°€ ë³µì¡í•´ì§ìœ¼ë¡œì¨ ì™¸ë˜í‚¤ë¥¼ ì•ˆ ì“¸ ìˆ˜ ìˆìŒ.
ê·¸ê²ƒë„ í•œ ë²ˆë§Œ loadXXX() ë¥¼ ì”€ìœ¼ë¡œì¨.
Entityì— product?: Product ë¡œ ì¹¼ëŸ¼ ì—†ì´ ì†ì„±ì„ ì¶”ê°€í•´ë‘ê³ 
`toDomain` ì—ì„œ ë„ë©”ì¸ ìƒì„±ì Factory í•˜ê¸° ì „ì—ë§Œ ì†ì„±ìœ¼ë¡œ ë„£ì–´ì£¼ë©´ ë¨. 

```typescript
entity.product = await this.loadProduct(entity.trackingProductId);
const domain = this.toDomain(entity);

// TrackingFactoryì—ì„œ ë°›ì•„ì˜¨ ì—”í„°í‹° ì¹¼ëŸ¼ ìì²´ì—ëŠ” productê°€ ì—†ì§€ë§Œ
// ì§ì „ì— tpId ì¹¼ëŸ¼ìœ¼ë¡œ ê°€ì ¸ì™€ì„œ ë„£ì–´ì¤Œìœ¼ë¡œì¨. 
static reconstitute(data: Record<string, any>): Tracking {
	const { id, userId, product, createdAt, updatedAt } = data;
```

#### ë¬¼ë¡  ì£¼ì˜í•´ì•¼ í•  ê²ƒì€ circular ì°¸ì¡°.
ì™¸ë˜í‚¤ ì—†ì´ ë‹¤ë¥¸ í…Œì´ë¸”ì—ì„œ idë¡œ ê°€ì ¸ì˜¤ë ¤ë©´ ì–´ì¨Œë“  ë‹¤ë¥¸ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì£¼ì…í•´ì•¼í•˜ëŠ”ë°,
ì´ê±´ í•œ ë°©í–¥ì´ì–´ì•¼ í•¨.
ìš°ë¦¬ì˜ ê²½ìš° Trackingì—ì„  ë‹¨ë°©í–¥ìœ¼ë¡œ product, catalog(Product[]), keywords(Keyword[]) ë¥¼ ì†ì„±ìœ¼ë¡œ ê°–ê³ ìˆê¸° ë•Œë¬¸ì— OK.
(Productì—ì„  Tracking Repositoryë¥¼ ì£¼ì…í•´ì„œ ì¡°íšŒí•  ì¼ì´ ì—†ìŒ)
```typescript
@Injectable()
export class TrackingTypeOrmAdapter {
    constructor(
        dataSource: DataSource,
        @Inject('IProductRepository')
        private readonly productRepository: IProductRepository,
    ) {}

    async loadProduct(productId: number): Promise<Product> {
        const product = await this.productRepository.findOne(new ID(productId));
        return product;
    }
```

#### ê¸°íƒ€ ì˜ì†ì„± ê³„ì¸µ ê´€ë ¨ ì‹¤ìˆ˜ë“¤

ì™œ ìˆëŠ”ë° ì—†ë‹¤ê³  ë‚˜ì˜¤ëŠ”ê°€?
TypeOrm ì¿¼ë¦¬ ë¡œê·¸ ì°íŒê±¸ë¡œ ê·¸ëŒ€ë¡œ ì°ì–´ë´ë„ ì•ˆë‚˜ì˜¤ëŠ” ì´ìœ ëŠ” 
deletedAt = nowë¡œ ë„£ì–´ë²„ë ¸ê¸° ë•Œë¬¸...
-> Aggregateë¥¼ ìƒì†í•´ì„œ ì˜ ì•ˆë³´ì¼ ìˆ˜ ìˆì§€ë§Œ ìƒì„±ìì—ì„œ deletedAtì€ ì¤‘ìš”í•˜ë‹¤..
```typescript
export class KeywordFactory {
    static create(keywordStr: string): Keyword {
        const now = DateUtil.now();

        const keyword = new Keyword(null, keywordStr, now, now, null);
        return keyword;
    }
```

reconstitute: new ID(id)
- ì™œ getterê°€ ì‘ë™ì„ í•œí–ˆì„ê¹Œ?
ë‹¹ì—°íˆ ë„ë©”ì¸ìœ¼ë¡œ ë§Œë“¤ë•Œ ìƒì„±ìì— new ID()ë¡œ ì•ˆë„£ì—ˆê¸° ë•Œë¬¸..

TypeOrm.forFeature([Entity]) -> ë„£ì–´ì£¼ì§€ ì•Šìœ¼ë©´ Metadata for Entity ë¥¼ ëª»ì°¾ìŒ

save ëŒ€ì‹  upsert í•´ì•¼í•˜ëŠ” ê²½ìš° ì˜ ì²´í¬. 

