+++
title = 'ÌÖåÏä§Ìä∏ ÏûëÏÑ±'
date = 2024-05-07T00:20:22+09:00
draft = true
+++
## Test
üü£ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ Î∞©Ïãù
ÌïëÌêÅÏù¥ ÏûàÏùå.
- ÌÅ¥ÎùºÏóêÏÑú await TrackingKeyword.updateList()ÏúºÎ°ú ÌÇ§ÏõåÎìú Îì±Î°ù ÏöîÏ≤≠Î≥¥ÎÇ¥Î©¥
ÏÑúÎ≤ÑÏóêÏÑ† Ïö∞ÏÑ† Îì±Î°ùÌõÑ res.send(200)ÏùÑ Ï£ºÍ≥† 
Îû≠ÌÇπÏ∂îÏ†Å Î∞è Ìï¥Îãπ keyword stat ÏóÖÎç∞Ïù¥Ìä∏Î•º Ìï®.
- Í∑ºÎç∞ Ïù¥ ÏöîÏ≤≠ ÏûêÏ≤¥Í∞Ä `closeAndReloadPage()`ÏóêÏÑú ÎÇòÍ∞ÄÎäîÍ±∞Í≥†,
Ïù¥ ÏöîÏ≤≠ ÌõÑÏóêÎäî `window.location.reload();`Í∞Ä Î∂àÎ¶¨Í≤å ÎêòÏñ¥ÏûàÏùå.
- Ï¶â ÏÑúÎ≤ÑÏóêÏÑú keyword statÏóê ÎåÄÌïú ÏùëÎãµÏùÑ Ï£ºÏßÄ ÏïäÎçîÎùºÎèÑ
ÌÅ¥ÎùºÏóêÏÑú ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®Ïù¥ ÏùºÏñ¥ÎÇòÎ©¥ÏÑú 
Îã§Ïãú Îç∞Ïù¥ÌÑ∞Î•º Î∞õÏïÑÏò¨ ÎïåÎäî Î∞©Í∏à ÌÅ¨Î°§ÎßÅÌïú Ïã†Í∑ú Îç∞Ïù¥ÌÑ∞Í∞Ä Îì§Ïñ¥Ïò§ÎäîÍ±∞ÏûÑ.

---
#### üü£ Í∞ÄÏû• Ï§ëÏöîÌïú Í±¥ ÏóêÎü¨Î•º Ïû¨ÌòÑÌïòÎäî Í≤É
Î°úÏª¨ÏóêÏÑú Ïö¥ÏòÅÍ≥º ÎèôÏùºÌïú ÏÉÅÌô©ÏùÑ ÎßåÎì§ Ïàò ÏûàÎäîÍ∞Ä?

Ïö¥ÏòÅÏóêÏÑú ÏÉà ÌÇ§ÏõåÎìúÎ•º Î∞©Í∏à Îì±Î°ùÌñàÏùÑ Îïå ÏÉÅÌíàÏ†ïÎ≥¥Ïóê ÌÇ§ÏõåÎìúÍ∞Ä ÏïàÎñ¥Îã§.

ÏΩîÎìú ÏûëÏÑ±Ìï†ÎïåÎäî Îñ¥ÎäîÎç∞ Í∑∏Í±¥ ÎÇ†ÏßúÎ•º Ïñ¥Ï†ú/Ïò§ÎäòÎ°ú Ï°∞ÏûëÌï¥ÎÜìÍ≥† Ìï¥ÏÑúÏòÄÍ≥†,
ÏÇ¨Ïã§ ÏàúÏÑú Î°úÏßÅÏóêÎßå ÏßëÏ§ëÌï† Í≤å ÏïÑÎãàÎùº
**Îçî Ï§ëÏöîÌïúÍ±¥ keyword_ranks[] ÌïÑÎìúÏóê 'Í∞í ÏûêÏ≤¥Í∞Ä Îì§Ïñ¥Ïò§ÎäîÍ∞Ä' ÏòÄÏùå..**
Í∑∏ ÏÉÅÌô©ÏùÑ Ïó¨Îü¨Í∞ÄÏßÄÎ°ú Í∞ÄÏ†ïÌï¥Î≥¥ÏßÄ ÏïäÏïòÎçòÍ±∞Í≥†.

Ï†àÎåÄ ÏÉùÍ∞ÅÌïòÍ∏∞ Ïñ¥Î†§Ïö¥ ÏºÄÏù¥Ïä§Í∞Ä ÏïÑÎãàÏóàÎã§.
Îû≠ÌÇπÏù¥ Ïñ¥Ï†ú/Ïò§Îäò Îã§ ÏûàÏùÑ Ïàú ÏûàÎäîÎç∞
Ïò§ÎäòÎßå ÏûàÎã§Î©¥? = Î∞©Í∏à Îì±Î°ùÌñàÎã§Î©¥?

ÌòÑÏû¨ ÎÇ¥Í∞Ä ÎßåÎì† APIÏôÄ Ïù¥Ï†Ñ APIÎ•º ÎëêÍ∞ú Îî± ÎùÑÏñ¥ÎÜìÍ≥† Í≤∞Í≥ºÍ∞íÏùÑ ÎπÑÍµêÌï¥Î¥êÏïºÌïúÎã§.
/listÏôÄ /list/legacy.
Îí§Ïóê /legacyÎßå Î∂ôÏù¥Î©¥ Î∞îÎ°ú ÎπÑÍµêÌï† Ïàò ÏûàÎäîÎç∞...

##### üü£ if else, for Ï†ÑÌõÑÎ•º Ïûò Î≥∏Îã§. Í∏∞Ïñµ. 'Ïù∏ÌíãÍ≥º ÏïÑÏõÉÌíã'
Ïù∏ÌíãÏúºÎ°ú Îì§Ïñ¥Ïò§Îäî keywordRanksÍ∞Ä if Î∏îÎ°ùÏóê ÏûàÏóàÏùÑÏßÄ else Î∏îÎ°ùÏóê ÏûàÏóàÏùÑÏßÄ.
Í∑∏ Ï°∞Í±¥ expressionÏù¥ ÎààÏóê Ïûò ÏïàÎì§Ïñ¥Ïò§Î©¥ Î∞îÎ°ú ÏïûÏóê Ï£ºÏÑùÏùÑ ÎÑ£Ïñ¥Ï£ºÍ≥†. (ÎÇ®ÎèÑ ÏïàÎ≥¥Ïù∏Îã§ÎäîÍ±∞ÎãàÍπå)

forÏóêÏÑú Î™®Îì† Ï≤òÎ¶¨Î•º Ìïú ÌõÑ
Î∞îÎ°ú Î∞ñÏóê Î°úÍ∑∏Î•º Ï∞çÏñ¥ÏÑú Í≤∞Í≥ºÎ¨º (ÏïÑÏõÉÌíã) Î®ºÏ†Ä Îî± ÌôïÏù∏. 


---


### ÌÖåÏä§Ìä∏ ÎßåÎì§Í∏∞ TIP
ÏßÄÍ∏àÏùÄ DB repoÎ•º mockingÌï† ÌïÑÏöîÍ∞Ä ÏóÜÎã§Îäî ÏÉùÍ∞ÅÏù∏Îç∞ (Í∑∏ÎÉ• e2eÎ°ú)
ÎÇòÏ§ëÏóêÎäî Ïä§ÌÑ∞ÎîîÎ•º ÌïòÎ©¥ÏÑú DB find, saveÎ•º Î™®ÌÇπÌï¥ÏÑú Ìï¥ÏïºÌïòÎäî Í≤ÉÎì§ÏùÑ Ìï¥ÏïºÌï†ÏàòÎèÑ.

usecase, service, parser Îî± ÏÑ∏ Í∞ú
- ÏÉÅÌíàÎì±Î°ùÏùò Í≤ΩÏö∞
    - mock scraper: html ÌÖçÏä§Ìä∏ Í∑∏ÎåÄÎ°ú input ÎÑ£Í∏∞ 
    - ÌååÏÑúÎßå Ï†úÎåÄÎ°ú ÎèôÏûëÌïòÎäîÏßÄ ÌÖåÏä§Ìä∏
- DB ÏÉÅÌò∏ÏûëÏö©ÏùÄ
    - repository.getÎßå Ïã§Ï†úÎ°ú ÌïòÍ≥†
    - saveÎßå mockÌïòÏûê.
        - saveÏóê Îì§Ïñ¥Í∞ÄÎäî Í∞íÎßå Ï†úÎåÄÎ°ú ÎêêÎäîÏßÄ ÌôïÏù∏.
    - getÎèÑ mockÌïòÏûê! (Ï≤òÏùåÏóê Ïñ¥Îñ§Í∞í ÏôÄÏïºÌïòÎäîÏßÄÎßå ÏΩòÏÜîÎ°ú Ï≤¥ÌÅ¨Ìïú ÌõÑ)
- ÎèÑÎ©îÏù∏ ÌÖåÏä§Ìä∏Îäî Îî±Ìûà ÌïÑÏöîÏóÜÏùÑÎìØ


---
### üü£ TODO

---
#### Promise.all ÌÖåÏä§Ìä∏ÏΩîÎìú
```typescript
describe('UserTrackingService', () => {
    let userTrackingService: UserTrackingService;
    let userTrackingKeywordRepository: UserTrackingKeywordRepository;
    let userProductGroupRepository: UserProductGroupRepository;
    let userTrackingCatalogRepository: UserTrackingCatalogRepository;
    let userTrackingAlarmRepository: UserTrackingAlarmRepository;

    beforeEach(() => {
        userTrackingKeywordRepository = {
            deleteByProductIds: jest.fn().mockResolvedValue(true),
        } as unknown as UserTrackingKeywordRepository;
        userProductGroupRepository = {
            deleteByProductIds: jest.fn().mockResolvedValue(true),
        } as unknown as UserProductGroupRepository;
        userTrackingCatalogRepository = {
            deleteByProductIds: jest.fn().mockResolvedValue(true),
        } as unknown as UserTrackingCatalogRepository;
        userTrackingAlarmRepository = {
            deleteByProductIds: jest.fn().mockResolvedValue(true),
        } as unknown as UserTrackingAlarmRepository;

        userTrackingService = new UserTrackingService(
            userTrackingKeywordRepository,
            userProductGroupRepository,
            userTrackingCatalogRepository,
            userTrackingAlarmRepository,
        );
    });

    describe('deleteMultiple', () => {
        it('should delete tracking ids if all deletions succeed', async () => {
            const userId = 1;
            const trackingIds = [1, 2, 3];
            const productIds = [4, 5, 6];
            jest.spyOn(userTrackingService, 'getMultipleProductIds').mockResolvedValue(productIds);
            jest.spyOn(userTrackingService, 'deleteByTrackingIds').mockResolvedValue();

            const result = await userTrackingService.deleteMultiple(userId, trackingIds);

            expect(result).toBe(true);
            expect(userTrackingService.deleteByTrackingIds).toHaveBeenCalledWith(userId, trackingIds);
        });

        it('should return false if any deletion fails', async () => {
            const userId = 1;
            const trackingIds = [1, 2, 3];
            const productIds = [4, 5, 6];
            jest.spyOn(userTrackingService, 'getMultipleProductIds').mockResolvedValue(productIds);
            jest.spyOn(userTrackingService, 'deleteByTrackingIds').mockResolvedValue();
            userTrackingKeywordRepository.deleteByProductIds = jest.fn().mockRejectedValue(new Error('Failed'));

            const result = await userTrackingService.deleteMultiple(userId, trackingIds);

            expect(result).toBe(false);
            expect(userTrackingService.deleteByTrackingIds).not.toHaveBeenCalled();
        });
    });
});


describe('UserTrackingService', () => {
    let userTrackingService: UserTrackingService;
    let userTrackingKeywordRepository: UserTrackingKeywordRepository;
    let userProductGroupRepository: UserProductGroupRepository;
    let userTrackingCatalogRepository: UserTrackingCatalogRepository;
    let userTrackingAlarmRepository: UserTrackingAlarmRepository;

    beforeEach(() => {
        userTrackingKeywordRepository = {
            deleteByProductIds: jest.fn().mockResolvedValue(true),
        } as unknown as UserTrackingKeywordRepository;
        userProductGroupRepository = {
            deleteByProductIds: jest.fn().mockResolvedValue(true),
        } as unknown as UserProductGroupRepository;
        userTrackingCatalogRepository = {
            deleteByProductIds: jest.fn().mockResolvedValue(true),
        } as unknown as UserTrackingCatalogRepository;
        userTrackingAlarmRepository = {
            deleteByProductIds: jest.fn().mockResolvedValue(true),
        } as unknown as UserTrackingAlarmRepository;

        userTrackingService = new UserTrackingService(
            userTrackingKeywordRepository,
            userProductGroupRepository,
            userTrackingCatalogRepository,
            userTrackingAlarmRepository,
        );
    });

    describe('deleteMultiple', () => {
        it('should delete tracking ids if all deletions succeed', async () => {
            const userId = 1;
            const trackingIds = [1, 2, 3];
            const productIds = [4, 5, 6];
            jest.spyOn(userTrackingService, 'getMultipleProductIds').mockResolvedValue(productIds);
            jest.spyOn(userTrackingService, 'deleteByTrackingIds').mockResolvedValue();

            const result = await userTrackingService.deleteMultiple(userId, trackingIds);

            expect(result).toBe(true);
            expect(userTrackingService.deleteByTrackingIds).toHaveBeenCalledWith(userId, trackingIds);
        });

        it('should return false if any deletion fails', async () => {
            const userId = 1;
            const trackingIds = [1, 2, 3];
            const productIds = [4, 5, 6];
            jest.spyOn(userTrackingService, 'getMultipleProductIds').mockResolvedValue(productIds);
            jest.spyOn(userTrackingService, 'deleteByTrackingIds').mockResolvedValue();
            userTrackingKeywordRepository.deleteByProductIds = jest.fn().mockRejectedValue(new Error('Failed'));

            const result = await userTrackingService.deleteMultiple(userId, trackingIds);

            expect(result).toBe(false);
            expect(userTrackingService.deleteByTrackingIds).not.toHaveBeenCalled();
        });
    });
});
```

---
ÏóÖÎç∞Ïù¥Ìä∏ Ïó¨Î∂Ä ÌåêÎã®
- ÌôïÏã§Ìûà info date(DB Ï†ÄÏû•Ïùº)Îäî 9ÏãúÍ∞Ñ Ïó¨Ïú†Î•º Îçî Ï£ºÎäîÍ±∞Í≥†
- ÏùºÏàò Îî∞ÏßàÎïåÎäî UTC Í∏∞Ï§ÄÏúºÎ°ú Ï∞®Í∞êÌï¥ÏÑú Ìï®. Ïñ¥Ï∞®Ìîº dateÍ∞Ä '2024-05-27' -> new DateÎ•º ÌïòÎ©¥ UTC Í∏∞Ï§ÄÏù¥ÎùºÏÑú.
```typescript
async mounted(): Promise<void> {
	await this.loadTrackingProductData(this.trackingId);

if (infoDate < currentDate && this.isNaverStore) {
try {
	await TrackingProduct.forceUpdate(trackingId);
	this.product = await TrackingProduct.getCurrentInfo(trackingId);

currentInfo(trackingId: number): string {
return 'v2/tracking/product/' + trackingId;

// ÏÇ≠Ï†ú Í∏∞Ï§Ä: selectedItemIds Í∏∏Ïù¥. 
if (this.selectedItemIds.length > 0) {
	const newList = await TrackingProduct.deleteMultiple(
	this.selectedItemIds,
	);

  private selectedItemIds: number[] = [];

// ÏÇ¨Ïã§ÏÉÅ Î∞∞Ïó¥Î°ú Ï¥àÍ∏∞ÌôîÌï¥ÎÜìÍ≥† ÌïòÍ∏∞ ÎïåÎ¨∏Ïóê .. productIdsÎ°úÎßå Í∞ÑÎã§Í≥† Î¥êÎèÑ Î¨¥Î∞©Ìï†ÎìØ?
@Watch('checkMap')
onCheckMapChanged(checkMap: any): void {
this.selectedItemIds = Object.keys(checkMap).map((i: string): number =>
	parseInt(i),
);

// -> Ï∂îÏ†Å idÎ•º ÌÜµÌïú ÏÉÅÌíà Í∏∞Î≥∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
https://api.itemscout.io/api/v2/tracking/product/:trackingId

productWithDate {
  _id: ID { _value: 221 },
  _createdAt: 2024-05-23T15:13:47.000Z,
  _updatedAt: 2024-05-23T15:13:47.000Z,
  _deletedAt: null,
  _url: 'https://smartstore.naver.com/feelhigh/products/10232630498',
  _metadata: {
    nvMid: '87777134065',
    mallPid: '10232630498',
    type: 0,
    channelUid: '2sWDwEDVVhxsnqdfMcLXl',
    title: 'ÎùºÏù¥ÌîÑÏùµÏä§ÌÖêÏÖò Ìà¨ÌçºÎç∞Ïù¥ Ï¢ÖÌï©ÎπÑÌÉÄÎØº V2 120Ï†ï',
    image: 'https://shop-phinf.pstatic.net/20240420_167/1713596357274HP4m8_PNG/114732255977442174_1932919058.png?type=m510',
    storeId: 500284216,
    regDate: null,
    initialCrawled: 0
  },
  date: 2024-05-23T15:00:00.000Z
}

```


üçè catalog
- ÌÖåÏä§Ìä∏Ìï† Îßå ÌïúÍ≤É
productDailyRepository.findOneByDateComparisons
	- Í≤∞Í≥º todayStatÏù¥ ÏûàÏúºÎ©¥ scrapeAndSummarizeÎ•º Ìò∏Ï∂úÌïòÏßÄ ÏïäÎäîÎã§.
	- /checkÏóêÏÑú Ïù¥ÎØ∏ ÌÅ¨Î°§ÎßÅÏùÑ ÌïòÍ≥†ÏôîÏúºÎØÄÎ°ú Ï†ïÏÉÅÏ†ÅÏù¥ÎùºÎ©¥ Ìò∏Ï∂ú ÏïàÌï®. 
- Í∑úÏπô:
	- Í≥†Ïàò: gosu>0, ÏÖÄÎü¨Î†àÎ≤® 3
	- Ï§ëÏàò: ranking>0, 2
	- Ï¥àÎ≥¥: extensionÎßå>0, 1

üçé GET ÏöîÏ≤≠ ÎßåÎì§Ïñ¥Ïïº Ìï® /tracking/product/catalog/337241
- Ïù¥Í≤å ÏïàÏôÄÏÑú Í∑∏Îü∞ÎìØ??
- 

```
catalogs [
  { id: 83, parentTpId: 221, tpId: 222 },
  { id: 84, parentTpId: 221, tpId: 223 },
  { id: 85, parentTpId: 221, tpId: 224 }
]
```


üçè group
- Í∑∏ÎÉ• reconstitute ÌÖåÏä§Ìä∏Î•º ÌïòÏÖàüçé
	- ÏóîÌÑ∞Ìã∞ Ï£ºÍ≥† toDomain ÌñàÏùÑÎïå ÌïÑÎìúÍ∞Ä ÎèÑÎ©îÏù∏ ÌïÑÎìúÎåÄÎ°ú Ïûò Ï†ïÏùòÎêêÎäîÏßÄ.

üçè scrapeDetailInfo(product)
- trackingÏù¥ ÏûàÏúºÎ©¥ Í∞Å ÏÉÅÌíà ÌÇ§ÏõåÎìúÏóê ÎåÄÌïú Îû≠ÌÇπÏ∂îÏ†Å ÏãúÏûë

üçè getRank
- ÌòÑÏû¨ ÏÉÅÌíà Îøê ÏïÑÎãàÎùº ÎπÑÍµêÏÉÅÌíàÎèÑ ÏµúÏã† Îû≠ÌÇπÏù¥ Ï∂îÏ†ÅÎêòÏñ¥Ïïº ÌïúÎã§.


```typescript
hihi keywords:  [
  Keyword {
    _id: ID { _value: 41762 },
    _createdAt: 2023-10-07T02:57:01.000Z,
    _updatedAt: 2023-10-07T02:57:01.000Z,
    _deletedAt: null,
    _keyword: 'Ïò§ÏèòÎ™∞'
  },
  Keyword {
    _id: ID { _value: 41763 },
    _createdAt: 2023-10-07T02:57:01.000Z,
    _updatedAt: 2023-10-07T02:57:01.000Z,
    _deletedAt: null,
    _keyword: 'Ïò§ÏèòÎ™∞Ïù¥ÎÆ®'
  }
]

hihi tracking:  Tracking {
  _id: ID { _value: 337240 },
  _createdAt: 2024-05-22T03:54:35.000Z,
  _updatedAt: 2024-05-22T03:54:35.000Z,
  _deletedAt: null,
  _userId: 2,
  _product: Product {
    _id: ID { _value: 219 },
    _createdAt: 2024-05-22T03:54:34.000Z,
    _updatedAt: 2024-05-22T03:54:34.000Z,
    _deletedAt: null,
    _url: 'https://smartstore.naver.com/neulbom_shopping/products/10177557576',
    _metadata: {
      nvMid: '87722060918',
      mallPid: '10177557576',
      type: 0,
      channelUid: '2scN29qHlGh6MTv0L4wjU',
      title: 'Ïò§ÏèòÎ™∞ Ïù¥ÎÆ® (Ïï°ÏÉÅ20ml+Ï†ïÏ†ú919mg) x 30Í∞úÏûÖ',
      image: 'https://shop-phinf.pstatic.net/20240319_125/1710851788769lIoYk_JPEG/38154472649068394_100334878.jpg?type=m510',
      storeId: 101896975,
      regDate: null,
      initialCrawled: 0
    }
  },
  _keywords: [],
  _catalogs: []
}
```


2. updateKeywordUseCase.trackRank
- trackingsÍ∞Ä ÏûàÏùÑ Í≤ΩÏö∞, Í∞Å ÏÉÅÌíà ÌÇ§ÏõåÎìúÏóê ÎåÄÌïú Îû≠ÌÇπ Ï∂îÏ†ÅÏùÑ Ïã§ÌñâÌïúÎã§

- üü£ Ïö∞ÏÑ† Ïñ¥ÎåëÌÑ∞ÏóêÏÑú ÏøºÎ¶¨Ìï®Ïàò ÎßåÎì§Í≥†, Ï£ºÏûÖÌïòÍ∏∞. 
	- Ïñ¥ÎåëÌÑ∞Îäî keywordRank.



3. TrackingPolicy: getAddableKeywordCount 




---
- saveAllProductDetails Ïú†ÎãõÌÖåÏä§Ìä∏
üê† **Í≤∞Íµ≠ÏùÄ private ÎßêÍ≥† Í∑∏ ÏïàÏóê repository Î©îÏÑúÎìú Í∞ÅÍ∞ÅÏóê ÎåÄÌï¥ mock Ìï¥Ï§òÏïº Ìï®. Í∑∏Í±∏Î°ú service FLOWÎ•º Î≥¥ÎäîÍ±∞Í≥†.**
    - createTrackingUsecaseÏùò createProduct Ìï®ÏàòÍ∞Ä// saveProductInfoService.saveProductÍ∞Ä rejectÌñàÏùÑ Îïå // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î°ú ProductSaveFailedError Í∞Ä Ï†ÑÌååÎêòÎäîÏßÄ ÌôïÏù∏ÌïòÍ≤†Îã§.

---
### Ï∞∏Í≥†
- Ìä∏ÎûúÏû≠ÏÖò ÌÖåÏä§Ìä∏Î•º ÏúÑÌï¥ÏÑ† @Transactional()Î•º mockÌïòÎ©¥ ÏïàÎê®.
	- ÎßåÏïΩ No CLS ÏóêÎü¨ Îú®Î©¥ beforeAllÏóêÏÑú `initializeTransactionalContext()` Ìï¥Ï£ºÍ≥†
	- beforeAllÏóê mock Ï∂îÍ∞ÄÌïòÎ©¥ ÎêòÎäîÎç∞. Íµ≥Ïù¥?
	```typescript
	    jest.mock('typeorm-transactional', () => ({
             Transactional: () => () => ({}),
         }));
	```


---
### jest.fn() vs jest.spyOn()

jest.fnÏùÄ Í∞ÄÏßú Ìï®ÏàòÎ•º ÏÉùÏÑ±ÌïúÎã§.
mockFn.mockReturnValue(Î¶¨ÌÑ¥Í∞í) 
mockFn.mockResolvedValue(Î¶¨ÌÑ¥Í∞í) -> Í∞ÄÏßú ÎπÑÎèôÍ∏∞ Ìï®Ïàò
mockImplementation(Íµ¨ÌòÑÏΩîÎìú)

```typescript
authContextService.getUserId = jest
	.fn()
	.mockImplementationOnce(() => {
		throw new HttpException(UNAUTHORIZED, 401);
	});
```
- mock Ìï®ÏàòÎ•º ÎßåÎì§Í≥† Í∑∏Í≤ÉÏùò Íµ¨ÌòÑÏùÑ ÏßÅÏ†ë ÏÇΩÏûÖ.
ÎßåÏïΩ () => {} ÏùµÎ™ÖÌï®ÏàòÍ∞Ä ÏïÑÎãå Í∑∏ÎÉ• new HttpExceptionÏùÑ ÌïòÎ©¥ ÎãπÏó∞Ìûà ÏïàÎê®.
Ìï®ÏàòÏù∏Îç∞ ÏóêÎü¨Í∞ùÏ≤¥Î•º ÎÑ£Ïñ¥Î≤ÑÎ¶¨ÎäîÍ±∞ÎãàÍπå..

jest.spyOn()ÏùÄ Ìï®Ïàò Íµ¨ÌòÑÏùÑ Í∞ÄÏßúÎ°ú ÎåÄÏ≤¥ÌïòÏßÄ ÏïäÍ≥†,
ÌäπÏ†ï Í∞ùÏ≤¥Ïùò Î©îÏÑúÎìúÏóê spyÎ•º Î∂ôÏó¨ÎÜìÍ≥†
Í∑∏ Î©îÏÑúÎìúÎ•º Ïã§ÌñâÌïòÎ©¥ 
Ïã§Ï†ú spyÍ∞Ä Î∂àÎ†∏ÎäîÏßÄ Ïïå Ïàò ÏûàÎã§. 

ÎÇ¥Í∞Ä Î≥¥Î†§Îäî Ìï®ÏàòÎäî videoÏù¥Í≥† Í±∞Í∏∞ÏÑú playÍ∞Ä Î∂àÎ†∏ÎäîÏßÄ ÏïåÍ≥†Ïã∂ÏùÑÎïå.
```typescript
const spy = jest.spyOn(video, 'play');
const result = video.play();

expect(spy).toHaveBeenCalled();
```

### Îëê Í∞ÄÏßÄ Î∞©Ïãù ÎπÑÍµê
Î¨¥ÏóáÏù¥ ÎÇòÏùÄÍ∞Ä?
Ïñ¥ÎäêÏ™ΩÏù¥Îì†Í∞ÑÏóê ÌäπÏ†ï Í≤∞Í≥ºÎ•º Î¶¨ÌÑ¥ÌïòÍ≤å ÌïòÎ†§Î©¥ `mockImplementation`ÏùÑ Ïç®ÏïºÌïúÎã§.
Ïôú `mockImplementation`ÏùÑ Ïì∞ÎäîÍ∞Ä?
Ï†ÄÎ†áÍ≤å ÌÖåÏä§Ìä∏ ÏΩîÎìúÎ•º ÏûëÏÑ±ÌïòÏßÄ ÏïäÏúºÎ©¥, authContext ÏóêÏÑú Íµ¨ÌòÑÏù¥ Î≥ÄÍ≤ΩÎê† Í≤ΩÏö∞ Ìï¥Îãπ ÌÖåÏä§Ìä∏Ïóê ÏòÅÌñ•ÏùÑ ÎÅºÏπòÍ∏∞ ÎïåÎ¨∏Ïóê ÏòÅÌñ• Î∞õÏßÄ ÏïäÎèÑÎ°ù mock Í∞ùÏ≤¥Î°ú ÎåÄÏ≤¥ÌïòÎäî Í≤ÉÏù¥Îã§.
- Í∑∏Í≤ÉÏù¥ `mockImplementation`Î°ú Ìï¥Îãπ Ìï®ÏàòÎ•º ÌÜµÏß∏Î°ú Ïû¨Íµ¨ÌòÑÌïòÎäî Í≤ÉÏù¥Îì†,
- mockReturnValueÎ°ú Î∞òÌôòÍ∞íÏùÑ Ï†ïÏùòÌïòÎäî Í≤ÉÏù¥Îì†.


ÏùòÎèÑÎäî Ïã§Ï†ú authContextServiceÏùò getUserId Ìï®ÏàòÍ∞Ä ÏûëÎèôÌïòÎäîÏßÄ ÏïåÎ†§Îäî Í≤å ÏïÑÎãàÎùº(Ïù¥Í±¥ Î≤îÏúÑÍ∞Ä ÏïÑÎãò)
getUserIdÍ∞Ä 401 ÏóêÎü¨Î•º ÎçòÏ°åÏùÑ Îïå Ìò∏Ï∂úÌï®ÏàòÏóêÏÑúÎèÑ 401ÏùÑ Î∞òÌôòÌïòÎÉêÎäî Í≤É.
Í∑∏Îü¨ÎÇò.. mockImplementationÏúºÎ°ú Ïù¥ÎØ∏ ÌäπÏ†ï ÏóêÎü¨Î•º Î∞òÌôòÌïòÎèÑÎ°ù ÏïÑÏòà ÎåÄÏ≤¥Ìï¥Î≤ÑÎ¶¨Î©¥
Í∑∏Í±∏ Î∞òÌôòÌïòÎäîÍ±¥ ÎÑàÎ¨¥ ÎãπÏó∞ÌïúÍ±¥Îç∞ ÌÖåÏä§Ìä∏Ïùò ÏùòÎØ∏Í∞Ä?


```typescript
// jest.fn() -> Í∞ÄÏßú Ìï®ÏàòÎ°ú ÎåÄÏ≤¥
it('userIdÍ∞Ä ÏóÜÏúºÎ©¥ 401 UNAUTHORIZED ÏóêÎü¨Í∞Ä Î∞úÏÉùÌïúÎã§', async () => {
	// Given
	authContextService.getUserId = jest
		.fn()
		.mockImplementationOnce(() => {
			throw new HttpException(UNAUTHORIZED, 401);
		});
	// Then
	await expect(
		groupUseCase.create(mockGroupCreateDto),
	).rejects.toThrowError(new HttpException(UNAUTHORIZED, 401));
});

// jest.spyOn -> ÌäπÏ†ï Î©îÏÑúÎìúÏóê spy Îã¨Í∏∞
it('userIdÍ∞Ä ÏóÜÏúºÎ©¥ 401 UNAUTHORIZED ÏóêÎü¨Í∞Ä Î∞úÏÉùÌïúÎã§', async () => {
	// Given
	const getContextUserIdSpy = jest
		.spyOn(authContextService, 'getUserId')
		.mockImplementation(() => {
			throw new HttpException(UNAUTHORIZED, 401);
		});
	// Then
	await expect(
		groupUseCase.create(mockGroupCreateDto),
	).rejects.toThrowError(new HttpException(UNAUTHORIZED, 401));

	expect(getContextUserIdSpy).toBeCalledTimes(1);
});
```




---
Ï†ÄÏû•/ÏóÖÎç∞Ïù¥Ìä∏ Ïú†Ïä§ÏºÄÏù¥Ïä§ ÌÖåÏä§Ìä∏
- spyOnÏúºÎ°ú ÌïòÎäî ÏºÄÏù¥Ïä§.
- ÏóêÎü¨ ÏºÄÏù¥Ïä§Îäî save ÏûêÏ≤¥Ïùò Ïã§Ìå®Î≥¥Îã§Îäî, .saveÏùò mockResolvedValueÍ∞Ä 
null ÎòêÎäî [] ÎπàÎ∞∞Ïó¥ Îì± ÎØ∏Î¶¨ Ï†ïÏùòÌïú ÏºÄÏù¥Ïä§Ïóê Îî∞Îùº
expect toThrowError ÌïòÎèÑÎ°ù ÌïòÎäî Í≤É.
- save Í≤∞Í≥ºÎ•º Í∞ÄÏßÄÍ≥† Ï†ïÏÉÅÏó¨Î∂ÄÎ•º ÌåêÎã®ÌïòÎäîÍ≤å ÎÇòÏÅòÏßÄ ÏïäÏùÄÎìØ. Î¨¥Ï°∞Í±¥ throw errorÎ≥¥Îã§.

```typescript
it('contract status ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ï†ÄÏû•Ïóê Ïã§Ìå®Ìï† Í≤ΩÏö∞, ÏóêÎü¨Î•º Î∞òÌôòÌïúÎã§.', async () => {
	const findByDocumentIdSpy = jest
		.spyOn(contractRepository, 'findByDocumentId')
		.mockResolvedValue(mockContract as any);

	const changeStatusByWebhhokTypeSpy = jest.spyOn(
		mockContract,
		'changeStatusByWebhhokType',
	);

	const saveSpy = jest
		.spyOn(contractRepository, 'save')
		.mockResolvedValue(null);

	await expect(
		contractService.updateContractStatus(mockContractWehhookDto),
	).rejects.toThrowError('FAILED_CONTRACT_STATUS_CHANGE');
	expect(findByDocumentIdSpy).toBeCalledTimes(1);
	expect(changeStatusByWebhhokTypeSpy).toBeCalledTimes(1);
	expect(saveSpy).toBeCalledTimes(1);
});

it('contract status ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ï†ÄÏû•Ïóê ÏÑ±Í≥µÌïúÎã§.', async () => {
	const findByDocumentIdSpy = jest
		.spyOn(contractRepository, 'findByDocumentId')
		.mockResolvedValue(mockContract as any);

	const changeStatusByWebhhokTypeSpy = jest.spyOn(
		mockContract,
		'changeStatusByWebhhokType',
	);

	const saveSpy = jest
		.spyOn(contractRepository, 'save')
		.mockResolvedValue({} as any);

	const result = await contractService.updateContractStatus(
		mockContractWehhookDto,
	);

	expect(result).toEqual(true);
	expect(findByDocumentIdSpy).toBeCalledTimes(1);
	expect(changeStatusByWebhhokTypeSpy).toBeCalledTimes(1);
	expect(saveSpy).toBeCalledTimes(1);
});
});
```