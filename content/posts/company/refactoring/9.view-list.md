+++
title = 'ì„œë²„ API í˜¸í™˜ì„±'
date = 2024-05-07T00:20:22+09:00
draft = true
+++
## ìƒí’ˆ ì¡°íšŒí•˜ê¸°

#### ðŸ‹ TODO
ì¼ë‹¨ ìƒí’ˆ ê¸°ë³´ì •ë³´ ì¡°íšŒ, ê·¸ë‹¤ìŒ ëž­í‚¹ì¶”ì  API ë‹¬ê³  ì¡°íšŒë„ ë‹¬ê¸°.

##### ì‚¬ìš©ìž ì¼ê°„ ëž­í‚¹ ì¶”ì  ìƒí’ˆ ë¦¬ìŠ¤íŠ¸
ðŸŸ£ getListWithKeywordStats ë¥¼ í˜¸ì¶œí•˜ëŠ” ì„¸ API.
- isSummaryì´ë©´ rank ë§¤í•‘ ì—†ì´ product infoë§Œ ì „ë‚ ê²ƒ ê°™ì´ ê°€ì ¸ì˜´. (/short- ê°¤ëŸ¬ë¦¬ë·°)
- 

### ðŸ’Ž ìƒê°.
- ì •ë§ë¡œ ë˜‘ê°™ì€ ì„œë¹„ìŠ¤ë¡œ ëŒ€ì²´ë  ê±° ì•„ë‹ˆë©´ serviceëŠ” ì¸í„°íŽ˜ì´ìŠ¤ êµ³ì´ ë§Œë“¤ í•„ìš” ì—†ì„ ìˆ˜ë„. usecase, outport ì™¸ì—ëŠ”.
- ðŸŽ scraper ì„œë¹„ìŠ¤ëŠ” ì˜¤í”ˆAPI, í¬ë¡¤ë§ ì™”ë‹¤ê°”ë‹¤ í•  í•„ìš”ê°€ ìžˆì–´ì„œ ì¸í„°íŽ˜ì´ìŠ¤ê°€ í•„ìš”í•˜ì§€ë§Œ (outportì™€ service ë¡œì§ ì¢…ì†ì„± ë¶„ë¦¬).
- policyëŠ” ì–´ì°¨í”¼ product, keyword policyê°€ ì“°ì´ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë‹¬ë¼ì„œ ì™„ì „ížˆ ëŒ€ì²´ ë¶ˆê°€.

ì„œë¹„ìŠ¤ë‚´ í•„ìš”í•œ íƒ€ìž…ë“¤ì€ ì¸í„°íŽ˜ì´ìŠ¤ë³´ë‹¤ëŠ” 
- service ì•ˆì— types í´ë” ë‘ê³  ì—¬ê¸°ì— ì¸í„°íŽ˜ì´ìŠ¤ë¡œ íƒ€ìž…ë“¤ì„ ì •ì˜í•œë‹¤.
- Type ëŒ€ì‹  interfaceë¥¼ ì“°ëŠ” ì´ìœ ëŠ” íƒ€ìž…ì€ ìƒì†ì´ ì•ˆë¼ì„œ.
- ì°¸ê³ ë¡œ ì¸í„°íŽ˜ì´ìŠ¤ëŠ” I ë¶™ì´ëŠ”ê²Œ ë§žìŒ
- DtoëŠ” swagger ìš©ìœ¼ë¡œë§Œ @SucessResponseë¡œë§Œ. 


#### ë‹¨ í•˜ë£¨ë„ ë°ì´í„°ê°€ ë¹ ì ¸ì„œëŠ” ì•ˆëœë‹¤..
ì¼ê°„ ì¶”ì ìƒí’ˆ ì¡°íšŒëŠ”. 
prev_infoë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë³€ë™ì„ í‘œì‹œí•˜ëŠ”ë°
ì „ë‚  ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ í¬ë¡¤ë§ì´ ì´ë¤„ì§€ì§€ ì•Šìœ¼ë©´ 
price, review_count, recent_saleì´ ë¹ ì§€ê²Œ ë¨..

### Swagger
```
@SuccessResponse(200, [
    {
        model: Number,
        exampleDescription: 'ìƒí’ˆ ë“±ë¡ ì„±ê³µ',
        exampleTitle: 'ìƒí’ˆ ë“±ë¡ ì„±ê³µ',
    },
])
```


---

ì „ë‚  ìƒí’ˆ ì •ë³´
- ì–´ë””ì„œ ê°€ì ¸ì˜¤ê³ , ì–´ë–»ê²Œ ì—°ì‚°í•˜ëŠ”ì§€.
  - prev info
  - tags

1. UserTracking.list(userId, tagId, page);
- ìœ ì €ê°€ ê·¸ë£¹(tagId)ë‚´ ë“±ë¡í•œ ìƒí’ˆë“¤. daily info 
2. UserTracking.getTotalPage(userId, tagId);
- íŽ˜ì´ì§€ë„¤ì´ì…˜ ìœ„í•œ. ê·¸ë£¹ì´ ìžˆìœ¼ë©´(tagId >0) user_product_tagì—ì„œ,
ê·¸ë£¹ì´ ì—†ìœ¼ë©´ user_trackingsì—ì„œ ì´ ëª‡íŽ˜ì´ì§€ ë‚˜ì˜¤ëŠ”ì§€ ë³´ë‚´ì¤€ë‹¤.
3. UserTrackingService.getListWithKeywordStats(list, userId);
- startDatetimeForKeywordRanking: ì–´ì œ, ì˜¤ëŠ˜ ëž­í‚¹ ë‘˜ ë‹¤.
- getPreviousDateString DateUtil ë„£ì–´ì•¼í•¨
- keywordIds : ìœ ì €ê°€ ì¶”ì ì¤‘ì¸ í‚¤ì›Œë“œë“¤ì„ DBì—ì„œ ê°€ì ¸ì˜¨ë‹¤
- rankChangedData
  - keywordsMapì€ kid:keywordStr ì¡°í•©
  - í‚¤ì›Œë“œ ëž­í‚¹ ë³€í™”ì•  ë”°ë¼ Up/Down/NoChangeë¡œ ë§µ. í‚¤ëŠ” tpId, ê°’ì€ rank, rank_diff
- TrackingProductInfo.getProductPrevStats

---
groupProductListRepository.getAllProductIds
- ìœ ì €ê°€ ì¶”ì ì¤‘ì¸ ìƒí’ˆ ì •ë³´ë“¤. ìµœê·¼ daily



** ìƒí’ˆíŽ˜ì´ì§€ì—ì„œ í‚¤ì›Œë“œ ëž­í‚¹ì€ ì¶”ê°€í•  ë•Œ, ë°°ì¹˜í•  ë•Œ ë”± ë‘ë²ˆìž„.
ìˆ˜ì§‘ ì•ˆë¼ìžˆìœ¼ë©´ ì‹¤ì‹œê°„ ìˆ˜ì§‘í•˜ëŠ”ê±° ì•„ë‹˜.


#### ðŸ‹ í•­ìƒ ì¸í’‹ê³¼ ì•„ì›ƒí’‹ ë¨¼ì € ë´ë¼.
ìƒí’ˆ ì¡°íšŒì˜ ê²½ìš°
finalListì— ë“¤ì–´ê°€ëŠ” statì˜ 
`keyword_rank_stats`, `prev_info` ë“± ë„¤ ê°€ì§€ í•„ë“œëŠ” 
`hasPermission` TRUE ì¼ ë•Œë§Œ ë„£ê²Œ ë˜ì–´ìžˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ full ì •ë³´ë¥¼ ìš”ì²­í•˜ëŠ” APIì—ì„œë„ 
hasPermissionì„ ë§¤ê°œë³€ìˆ˜ë¡œ ë„£ì–´ì„œ 
ì´ê²Œ falseë©´ ì• ì´ˆì— ê³„ì‚°ì„ ì•ˆí•˜ë„ë¡ í•´ì•¼í•˜ëŠ” ê²ƒì´ë‹¤.

ìž˜ ë³´ë©´.
addRankInfo í•¨ìˆ˜ëŠ” ì˜¤ì§ `keyword_rank_stats`ë¥¼ í•„ë“œì— ë„£ê¸°ìœ„í•´ ì¡´ìž¬í•˜ë¯€ë¡œ.
hasPermission = Falseë©´ í•  í•„ìš”ê°€ ì—†ë‹¤.


#### ðŸ‹ ê²°êµ­ ë°˜ë³µë˜ëŠ” ì½”ë“œë¥¼ í•¨ìˆ˜ë¡œ ë¬¶ëŠ” ê²ƒ.
ë˜‘ê°™ë‹¤.
rank up, down, sameì— ëŒ€í•´
í•œ rankê°€ ë†’ì€(ì ˆëŒ€ê°’ì´ ìž‘ì€) ìˆœìœ¼ë¡œ ì •ë ¬í•˜ëŠ” ê²ƒ.


```javascript
recentKeywordRankingStats [
  {
    id: 21344,
    date: '2024-05-17',
    timestamp: 1715917124000,
    createdAt: 2024-05-17T03:38:44.000Z,
    keywordId: 74577,
    trackingProductId: 166,
    rank: 111,
    tie: 0,
    tieRank: 0
  },
  {
    id: 21343,
    date: '2024-05-17',
    timestamp: 1715916592000,
    createdAt: 2024-05-17T03:29:52.000Z,
    keywordId: 9127,
    trackingProductId: 185,
    rank: 7,
    tie: 0,
    tieRank: 0
  }
]

keywordsMap { '9127': 'ì²­í‚¤', '74577': 'ë¸”ëž™ì‚¬íŒŒì´ì–´' }

// tpId: {}
// Objectì— ì–´ë–¤ ë°ì´í„°?
// statKey = trackingProductId + '-' + keywordId;

rankChangedData {
  resultRankUpMap: {},
  resultRankDownMap: {},
  resultRankNotChangedMap: { '166': [ [Object] ], '185': [ [Object] ] }
}

---
1ë²ˆ ë°ì´í„°
 RowDataPacket {
    id: 199,
    tp_id: 167,
    type: 0,
    mall_pid: '5622431406',
    mall_name: 'ê¸ˆë©”ë‹¬ë†ì‚°ë¬¼',
    price: 13900,
    keywords: 'ìˆ˜ìž…í¬ë„,ë¸”ëž™ì‚¬íŒŒì´ì–´,ì²­í¬ë„,ê³ ë‹¹ë„ê³¼ì¼,ì í¬ë„,ì‹ ì„ ,ìƒí¼ê³¼ì¼,ìƒí¼í•œê³¼ì¼,ìŠ¤ìœ„íŠ¸í”Œë£»,ìƒì½¤',
    review_count: 1060,
    review_score: 4.62,
    recent_sales: 0,
    title: 'ê³ ë‹¹ë„ í¬ë„ í¬ë¦¼ìŠ¨ ì• í”Œ ì²­í¬ë„ ë¸”ëž™ ì•„ë„ë¼ ì´ë‹ˆì•„ ì‚¬íŒŒì´ì–´ ìº”ë””í•˜íŠ¸ ì†œì‚¬íƒ• ê°€ì§€ í¬ë„',
    image: 'https://shop-phinf.pstatic.net/20220712_6/1657620640491H4qJS_JPEG/58756475276434917_32324876.jpg',
    nv_category_id: 50002180,
    reg_date: null,
    created_at: 2024-04-25T05:15:25.000Z,
    is_overseas: 0,
    is_tied: 0
  }
---
3ë²ˆ ë°ì´í„°
  RowDataPacket {
    // 1ë²ˆì—ì„œ ì¶”ê°€ëœ ë¶€ë¶„
    keyword_rank_stats: [],
    catalog_count: 0,
    prev_info: {
      price: 24800,
      review_count: 48,
      recent_sale: 0,
      review_score: 4.85,
      date: '2024-05-16'
    },
    tags: []
  },

```

---
ðŸŽ ëž­í‚¹ë°ì´í„° ì¡°íšŒ
1-1. ðŸ‘ ëž­í‚¹: v2/tracking/product/166/keywords/ranks?
startDate=2024-04-16&endDate=2024-04-17&keywords=35207%2C35514
- rank, adRank, 
"rank": {
    "166": [
        {
            "rank": 101,
            "tie": 0,
            "tieRank": 0

1-2. v2/tracking/product/166/keywords/ranks?
startDate=2024-04-23&endDate=2024-04-23&keywords=389713
- "data":{"389713":[{"rank":101,"date":"2024-04-23"}]}}

2. ê·¸ëž˜í”„: v2/tracking/product/graph/166?startDate=2024-04-16&endDate=2024-04-23&isExample=fal

3. ì¼ë°˜: v2/tracking/product/general/166?isExample=false
- ProductDetailInfo


4. /v2/tracking/keyword/stat/198
ê²€ìƒ‰ìˆ˜, ìƒí’ˆìˆ˜

5. v2/tracking/product/daily/198?startDate=2024-04-23&endDate=2024-04-23
- tags, price, cate_id, overseas, ìž¡ë‹¤.

- addable
    - permission ì²´í¬. -> user.checkLimitì´ ëž­í‚¹ì¶”ì  ì„œë¹„ìŠ¤ 
- POST tracking/keyword/:trackingId



ðŸ’Ž ì¡°íšŒ
1. í‚¤ì›Œë“œì— ëŒ€í•œ ì¼ê°„ ëž­í‚¹ ì¶”ì  list
v2/tracking/keyword/rank/:trackingId/:keywordId

2. ìƒí’ˆ ì¢…í•©ì •ë³´(í‘œ): /v2/tracking/product/general/:trackingProductId
3. ì‹œê³„ì—´ ì •ë³´(ê·¸ëž˜í”„): v2/tracking/product/graph/:trackingProductId?startDate=&endDate=


---
#### ì¶”í›„ ë”°ë¡œ ì—°ìŠµí•´ ë³¼ ê²ƒë“¤

```javascript
function getRankingChangedData(stats, keywordsMap) {
    let resultRankUpMap = {};
    let resultRankDownMap = {};
    let resultRankNotChangedMap = {};

    let statsMap = {};
    let unhandledStatsMap = {};

    stats.forEach(stat => {
        const { date, keywordId, trackingProductId, rank, timestamp } = parseStat(stat);
        const statKey = `${trackingProductId}-${keywordId}`;

        updateStatsMap(statsMap, unhandledStatsMap, statKey, date, rank, timestamp);

        if (statsMap[statKey]) {
            handleRankComparison(statsMap[statKey], rank, keywordId, trackingProductId, keywordsMap, resultRankUpMap, resultRankDownMap, resultRankNotChangedMap);
        }
    });

    handleUnhandledStats(unhandledStatsMap, keywordsMap, resultRankNotChangedMap);
}

function parseStat(stat) {
    return {
        date: parseInt(stat.date.replace(/-/g, '')),
        keywordId: stat.keywordId,
        trackingProductId: stat.trackingProductId,
        rank: stat.rank,
        timestamp: stat.timestamp
    };
}

function updateStatsMap(statsMap, unhandledStatsMap, statKey, date, rank, timestamp) {
    if (!statsMap[statKey]) {
        statsMap[statKey] = { date, rank, timestamp };
        unhandledStatsMap[statKey] = { date, rank, timestamp };
    }
}

function handleRankComparison(currentStat, newRank, keywordId, trackingProductId, keywordsMap, upMap, downMap, unchangedMap) {
    const rankDiff = newRank - currentStat.rank;
    const rankChangeMap = rankDiff > 0 ? upMap : rankDiff < 0 ? downMap : unchangedMap;

    if (!rankChangeMap[trackingProductId]) {
        rankChangeMap[trackingProductId] = [];
    }

    rankChangeMap[trackingProductId].push({
        keyword_id: keywordId,
        keyword: keywordsMap[keywordId],
        rank: currentStat.rank,
        rank_diff: rankDiff,
        timestamp: currentStat.timestamp
    });
}

function handleUnhandledStats(unhandledStatsMap, keywordsMap, unchangedMap) {
    Object.keys(unhandledStatsMap).forEach(key => {
        const stat = unhandledStatsMap[key];
        const { trackingProductId, keywordId, rank, timestamp } = stat;

        if (!unchangedMap[trackingProductId]) {
            unchangedMap[trackingProductId] = [];
        }

        unchangedMap[trackingProductId].push({
            keyword_id: keywordId,
            keyword: keywordsMap[keywordId],
            rank,
            rank_diff: 0,
            timestamp
        });
    });
}

```