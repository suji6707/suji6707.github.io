+++
title = 'ì„œë²„ API í˜¸í™˜ì„±'
date = 2024-05-07T00:20:22+09:00
draft = true
+++
## ê¸°ì¡´ ì„œë²„ API í˜¸í™˜ì„±

#### ğŸ‹ ì…‹íŒ… ê´€ë ¨ ëª°ì•„ì„œ ì§ˆë¬¸í•˜ê¸°
- @UsePipes(new ValidationPipe({ transform: true }))
  - ì™œ ë¶™ì—¬ì•¼í•¨? ì–´ë–¤ê²½ìš°ì—?
- 

#### ê·¸ ì™¸ ë„ë©”ì¸ ì§ˆë¬¸
- TrackingProductSaleCounts.insert
  - ì´ ì •ë³´ê°€ ì–¸ì œ ì“°ì´ì£ ?
    - ìƒí’ˆë“±ë¡ì‹œ ì²˜ìŒì—ë§Œ ë“¤ì–´ê°€ì§€ë§Œ 
    - ì‹œê³„ì—´ì´ ê°€ëŠ¥í•œ ìœ ì¼í•œ ê²½ìš°ëŠ” ê·¸ê²ƒì„ ì¤‘ë³µí•´ì„œ ë“±ë¡í•  ë•Œ.
      - productëŠ” ìˆìœ¼ë©´ ëŒë ¤ì£¼ì§€ë§Œ
      - ë°˜ë“œì‹œ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ í¬ë¡¤ë§ + detail infoëŠ” ê°€ì ¸ì™€ì„œ ì €ì¥í•˜ê²Œ ë˜ì–´ìˆë‹¤.

#### í…ŒìŠ¤íŠ¸í•  ìœ„í—˜ ìš”ì†Œë“¤
- addable: ê°€ëŠ¥í•˜ì§€ ì•Šì„ ê²½ìš° serviceì—ì„œ try catchë¡œ ì¡ì•„ì£¼ì§€ ì•Šì•„ë„ ì˜ ì‘ë™í•˜ëŠ”ê°€?
- INSERT IGNORE INTO : ì¤‘ë³µìˆìœ¼ë©´ insertê°€ ë°œìƒí•˜ì§€ ì•Šê³  result.insertId = 0ì´ ëœë‹¤.

#### DTO ì—ëŸ¬ í•´ê²°
ğŸŸ£ ê²°êµ­ stringìœ¼ë¡œ ì˜¤ëŠ”ê±°ê³ 
í•­ìƒ app.bodyParser json, urlencoded ë¯¸ë“¤ì›¨ì–´ ê±°ì³ì„œ ìš”ì²­ì„ ë°›ëŠ”ê±°ì„.

ğŸŸ£ ê·¼ë³¸ì ì¸ ì›ì¸ì€
í´ë¼ì´ì–¸íŠ¸ headerë¥¼ header: req.headerë¡œ ê·¸ëŒ€ë¡œ ë³´ë‚¸ ê²ƒì´ ë¬¸ì œì„.
Request.headerë¥¼ ë³´ë©´ application/x-www-form-urlencoded ì´ê³  (Response.header ë§ê³ . ì‘ë‹µí—¤ë”ëŠ” ì„œë²„ì—ì„œ ì‘ë‹µí•´ì£¼ëŠ” íƒ€ì…ì´ê³ )
ì´ê²ƒì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ urlencoded íƒ€ì…ìœ¼ë¡œ ì£¼ê² ë‹¤ëŠ” ëœ».

ê·¼ë° ì„œë²„ë¡œ ë„˜ì–´ì˜¤ë©´ app.bodyParser ë¯¸ë“¤ì›¨ì–´ë¥¼ app ì„œë²„ ìì²´ì—ì„œ ê±°ì¹˜ë¯€ë¡œ
í•œë²ˆ JSONìœ¼ë¡œ íŒŒì‹±ì„ í•˜ê²Œ ë¨.
ê·¸ëŸ¼ JSONìœ¼ë¡œ =ì¸ ê²ƒì„ 
req.header ì˜ urlencodedë¡œ ê·¸ëŒ€ë¡œ Nest.jsë¡œ ë³´ë‚´ê²Œ ë˜ë©´ (axiosê°€ ê·¸ê±¸ stringify, parse)
Nest ì„œë²„ì—ì„  í‚¤=ê°’ì´ urlencoded íƒ€ì…ì´êµ¬ë‚˜ ë¡œ ì¸ì‹í•´ì„œ
JSONìœ¼ë¡œ ë°”ê¿€ ë•Œ í‚¤:ê°’ìœ¼ë¡œ ë°”ê¿”ë²„ë¦¬ëŠ” ê²ƒ.



```javascript
// POST í˜ëŸ¼ì„ Jsoní˜•íƒœë¡œ ë°˜í™˜ëœ, req.body ë¥¼ ì‚¬ìš©í•˜ë©´ jsonìœ¼ë¡œ ë°˜í™˜ë¨
app.use(cookieParser());
app.use(bodyParser.json({ limit: '10mb' }));
app.use(bodyParser.urlencoded({ 
    limit: '10mb',
    extended: false,
}));
```

Nestì—ì„œë„ ì•„ë˜ì™€ ê°™ì´ ì„¤ì •í•˜ë©´ ë˜ê² ì§€ë§Œ
ì§€ê¸ˆ ë¬¸ì œëŠ” ê·¸ê²Œ ì•„ë‹˜.

"Convert JavaScript object into URI-encoded string"
ìš°ë¦¬ ì‚¬ì´íŠ¸ëŠ” xxx urlencodedë¥¼ ì»¨í…íŠ¸ íƒ€ì…ìœ¼ë¡œ ì“°ê³ ìˆê³  (í´ë¼ì´ì–¸íŠ¸ Nuxtë„ ì—¬ê¸°ì— ë§ì¶°ì ¸ìˆìŒ)
urlencoded íƒ€ì…ìœ¼ë¡œ ë°›ì€ ë°ì´í„°ë¥¼ 
axiosê°€ JSONìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ìƒê¸°ëŠ” ê²ƒ.
(ê·¸ê²ƒì´ url ìŠ¤íŠ¸ë§ì´ë“  ë‹¤ë¥¸ íƒ€ì…ì´ê±´ ìƒê´€ì—†ì´ ê°ì²´ë©´ ë‹¤ ë¬¸ì œìƒê¹€)
ê·¸ëŸ¼ ìš°ë¦¬ëŠ” urlencodedë¥¼ urlencoded íƒ€ì… ê·¸ëŒ€ë¡œ ë°›ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ í•„ìš”.
```
// Raw body íŒŒíŠ¸ ì°¸ì¡°
const app = await NestFactory.create<NestExpressApplication>(AppModule, {
  rawBody: true,
});
app.useBodyParser('json', { limit: '10mb' });
```
ì°¸ê³ ë¡œ urlencodedë¥¼ íƒ€ë©´ ë‹¤ ìŠ¤íŠ¸ë§ì´ ë¨. íƒ€ì… êµ¬ë¶„ì´ ì—†ì–´ì§.
```
var prms = new URLSearchParams({
  firstName: "Jonas",
  lastName: "Gauffin"
});
console.log(prms.toString());
// firstName=Jonas&lastName=Gauffin
```

ë ˆê±°ì‹œ -> Nest ìš”ì²­ì‹œ
req.headers['content-type'] = 'application/json'; ë„£ì–´ì•¼ ë¨
(ì°¸ê³ )
application/x-www-form-urlencoded ëŠ” ë§ê·¸ëŒ€ë¡œ urlë¡œ ì›¹ì„œë²„ì— ë°ì´í„° ì „ì†¡í•˜ëŠ” íƒ€ì…
í‚¤-ê°’ì„ = , ê° ìŒì€ &, ê³µë°±ì€ +ë‚˜ %20
ê·¸ë˜ì„œ urlì— =ê°€ ìˆìœ¼ë©´ urlencodedì—ì„œ ì´ê±¸ í‚¤/ê°’ìœ¼ë¡œ ì¸ì‹í•´ë²„ë¦¬ê³ , axiosê°€ jsonìœ¼ë¡œ ë³€í™˜í•  ë•Œ : ìœ¼ë¡œ ë°”ê¿”ë²„ë¦°ë“¯..
ë‘ê°€ì§€ ë‹¤ ì¨ì•¼ ì œëŒ€ë¡œ ë³€í™˜ë¨
@Type(() => Number) (class-transformer) - ì™œ ë³€í™˜ì´ ì•ˆë˜ëŠ”ì§€ ëª¨ë¥´ê² ìœ¼ë‚˜ ì´ê²Œ ì—†ìœ¼ë©´ validatorì—ì„œ íŠ•ê¹€ ã…œ
ValidationPipe (class-validator) - ê²€ì¦ì´ê¸´ í•œë°, transform: trueê°€ ìˆì–´ì•¼ ì œëŒ€ë¡œ ë³€í™˜ë¨



### íŠ¸ëœì­ì…˜ ì ìš©í•˜ê¸°
- í•¨ìˆ˜ë¡œ ë”± ê·¸ë¶€ë¶„ë§Œ ë¹¼ì„œ í•  ê²ƒì¸ê°€

1. ìƒí’ˆë“±ë¡
2. í‚¤ì›Œë“œë“±ë¡
- insert restAll ì—ì„œë§Œ í•˜ë©´ ë˜ëŠ”ê°€?


#### íŒŒì‹±
- cheerio
  - ViaHTMLë¡œ íŒŒì‹±í•˜ëŠ” ê²½ìš°.
    - scraperëŠ” htmlë§Œ stringìœ¼ë¡œ ì£¼ê³ 
    - íŒŒì„œì—ì„œ ê·¸ htmlë¥¼ cheerio ë¡œë“œí•œ í›„ íŒŒì‹±í•œë‹¤
    - ğŸŸ£ cheerioë¥¼ íŒŒì„œì—ì„œ ì±…ì„ì§€ëŠ” ê±¸ë¡œ í•©ì‹œë‹¤!
      - ì›ë˜ëŠ” ìŠ¤í¬ë˜í¼ ì—­í• ì¸ requestPageì—ì„œ $: cheerio.loadë¡œ ë³€í™˜ í›„ ì „ë‹¬í–ˆì—ˆìŒ. 
      - ì´ë ‡ê²Œ í•´ë„ë˜ëŠ”ë° ì´ë¯¸ scrapHelper.retrieve í•¨ìˆ˜ì—ì„œ ê·¸ëƒ¥ dataë§Œ ì „ë‹¬í•˜ë„ë¡ í•´ë‘”ì§€ë¼.. (ì—¬ê¸°ì— ì¸í„°ì…‰í„°ë¥¼ ë‘ê³  html bodyì™€ í•¨ê»˜ $ cheerio loadë¥¼ ê°™ì´ ì£¼ë„ë¡ í•´ë„ë˜ê¸´ í•¨ ê·€ì°®ì„ë“¯)
```typescript
getProductDailyInfoViaHTML(html: string) {
    let body = null;
    const $ = cheerio.load(html);
```

---
#### /usage, /addable ë¨¼ì €
- ë‘˜ ë‹¤ ë³„ë„ ìœ ìŠ¤ì¼€ì´ìŠ¤ ì—†ì´ trackingPolicyService ë¡œ ë°”ë¡œ ë„˜ê¸°ê² ìŒ.
- ë ˆê±°ì‹œ ì„œë²„ ì—°ë™
  - ë‚˜ì¤‘ì— route ìƒˆë¡œ íŒŒê³  session checker ë¯¸ë“¤ì›¨ì–´ ë„£ê¸°.
    v4 ê°™ì´ ì–´ë””ì— ì •ì˜í• ì§€ ê²°ì •.
  - ë ˆê±°ì‹œì— ë§ˆì € ì¶”ê°€í•˜ê¸°
    - keyword/addable


#### example
authLegacyGuard ë¹¼ê³  í•˜ê¸°.



#### /check
ğŸ’ check í›„ user tracking ìë™ìœ¼ë¡œ ì €ì¥í•˜ì§€ë§Œ
ì›ë˜ ìˆë˜ APIëŠ” í˜¸í™˜ì„± ìœ„í•´ ë§Œë“¤ì–´ë‘ê¸° trueë§Œ ë¦¬í„´í• ì§€ì–¸ì •

ë§ì€ ê³¼ì •ë“¤ì´ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì—¬ìˆë‹¤. í…ŒìŠ¤íŠ¸ !!
create
- í¬ë¡¤ë§ í›„ product ë° product daily íŒŒì‹±
- product, daily, ê¸°íƒ€ ì •ë³´ë“¤ ì €ì¥
  - ì´ë•Œ product.idê°€ ë™ì¼í•˜ê²Œ tpIdë¡œ ë“¤ì–´ê°€ëŠ”ì§€ ì£¼ì˜.
- user tracking ì €ì¥.
- idë§Œ ë¦¬í„´

- ** product infoë„ ì˜¤ëŠ˜ì ìˆëŠ”ì§€ í™•ì¸í•˜ë‚˜??



#### ê¸°íƒ€ ì—°ë™ ê´€ë ¨
router.get('/addable', async (req, res, next) => {
- ê¼­ next ë„£ì–´ì•¼ í•˜ë‚˜?

ì¿ í‚¤: ì¿ í‚¤ ë§Œë£Œì•¼ ê·¸ë ‡ë‹¤ ì³ë„ ë‹¤ë¥¸ ìœ ì €ë¡œ ë¡œê·¸ì¸í•˜ë©´ ì¿ í‚¤ë¥¼ ë§Œë£Œì‹œì¼œë²„ë¦¬ëŠ”ê±´ê°€?



#### ì—ëŸ¬ì²˜ë¦¬
throw new Error -> ëŠ” ê·¸ëƒ¥ UNKOWN ì—ëŸ¬ë¡œ í´ë¼ì— ì „ë‹¬ë¼ë²„ë¦¼.
ğŸŸ£ HttpException ìœ¼ë¡œ í•´ì¤˜ì•¼ Exception filterë‹¨ì—ì„œ ì¡í˜€ì„œ setErrorë¡œ ì˜ ë‚˜ê°€ë‚˜ë´„.

ì•„ë‹ˆë©´ ì—ëŸ¬ ì²˜ë¦¬í•  ë•Œ 
ì—ëŸ¬í•¸ë“¤ëŸ¬ì—ì„œ ì—ëŸ¬ íƒ€ì…ìœ¼ë¡œ í•¸ë“¤ë§í•´ë„ ë¨.


#### ì™¸ë¶€ API ì—ëŸ¬ì²˜ë¦¬
ë‘ ê°€ì§€ ë™ì‘ì´ ìˆìŒ.
1. ë¡œê·¸ë¥¼ ì°ëŠ”ê²ƒ : data.error_msg
2. í´ë¼ì´ì–¸íŠ¸ì— ì‘ë‹µì„ í•˜ëŠ” ê²ƒ : data.status code, ì „ì²´ data
- dataì—ëŠ” ì—ëŸ¬ë©”ì‹œì§€, ìƒíƒœì½”ë“œ ë“±ì´ ëª¨ë‘ í¬í•¨ë˜ì–´ìˆê³  ì½œìŠ¤íƒë„.

```javascript
res.setError = function (_err, isApiError = false) {
    if (isApiError) {
        logger.error(_err?.response?.data?.error_msg ?? _err);
        _err?.response?.data 
        ? res.status(_err.response.data.result_code).send(_err.response.data) 
        : res.setError(_err);
    }
```


