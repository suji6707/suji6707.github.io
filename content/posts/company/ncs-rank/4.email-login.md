+++
title = 'ë¹„ìƒì‹œ ëŒ€ì‘'
date = 2024-07-11T00:20:22+09:00
draft = true
+++
## NCS ì´ë©”ì¼ ë¡œê·¸ì¸ ë„ì…

ë“¤ì–´ê°€ê¸° ì•ì„œ.
ì–´ë–¤ ê¸°ëŠ¥ì„ ë§Œë“¤ë¼ê³  í•˜ë©´
ê·¸ í™”ë©´ì— ë­ê°€ ìˆëŠ”ì§€ë¥¼ ë¨¼ì € ë³¸ë‹¤.
ë°°ë„ˆê°€ ìˆìœ¼ë©´ ë©”ì‹œì§€ì™€ ë§í¬ê°€ ìˆì„ ìˆ˜ ìˆë‹¤ - ë²”ìš© ë©”ì‹œì§€ë‹¤.
ê·¸ëŸ¬ë©´ í•„ë“œ ë‘ ê°œë©´ ë˜ê² êµ¬ë‚˜.
ë”°ë¡œ insert ë¡œì§ ì—†ì´ DBì— ìˆ˜ê¸° ì…ë ¥í•˜ë©´ ë˜ê² êµ¬ë‚˜.

---

### POST /ncs/email/login
1. ì»¤ë¨¸ìŠ¤ ID ë¹„ì •ìƒ ì—¬ë¶€ check
- DB ì¡°íšŒ
2. users í…Œì´ë¸”ì— email ìˆëŠ”ì§€ ì²´í¬
ìˆìœ¼ë©´ ë°°ì—´ë¡œ ê°€ì ¸ì˜¤ê¸°
ì—†ìœ¼ë©´ throw Error (ì´ë©”ì¼ ì¸ì¦ì„ í•˜ì§€ ì•Šì€ ìœ ì €ì…ë‹ˆë‹¤ -> ì›ë˜ ì»¤ë¨¸ìŠ¤ì†”ë£¨ì…˜ ê²½ë¡œì—ì„œ ì´ë©”ì¼ì¸ì¦ ê±°ì³ì•¼.)
3. email-login-token í…Œì´ë¸”
í† í° ìœ íš¨í•œì§€ ì²´í¬(expiresAt < 5), used 0
1) ìœ íš¨í•œ í† í°ì´ ì—†ìœ¼ë©´ url ë§Œë“¤ê¸°
2) ìœ íš¨í•œ í† í°ì´ ì´ë¯¸ ìˆìœ¼ë©´ throw Error (ì´ë¯¸ ì¸ì¦ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. 5ë¶„ í›„ ë‹¤ì‹œ ì¸ì¦ë§í¬ë¥¼ ìš”ì²­í•´ì£¼ì„¸ìš”)
4. url ë§Œë“¤ê¸°
{NCS_SERVER_API_URL}/ncs/email/login?userId=O&token=O

5. ì´ë©”ì¼ ì „ì†¡í•˜ê¸°
change-email serviceê°€ ì•„ë‹ˆë¼ ê·¸ëƒ¥ email serviceë¡œ ë°”ê¿”ì•¼í•¨.
1) favicon: ë©”ì¸ì„œë²„ë„ svgë¡œ ë„£ê¸°.
- ê·¸ì „ì— gmailë¡œë„ svg ì˜ ì˜¤ëŠ”ì§€ ë³´ê³  ë©”ì¸ì„œë²„ ejs ë°”ê¿”ì„œ ë°°í¬í•˜ê¸°.
2) ì—¬ëŸ¬ ê³„ì •ìœ¼ë¡œ ì£¼ê¸°
3) css ë§ì¶”ê¸°
4) ë§í¬ë¡œ ì ‘ì†ì‹œ ë¡œê·¸ì¸ ë˜ë„ë¡ ë§Œë“¤ê¸°
https://local.itemscout.io:3008/api/ncs/email/login?token=b71f5ab7-de25-4068-8451-a0581615e873&userId=1

ğŸ’ svg ì´ë¯¸ì§€ ë„£ëŠ” ë” ì¢‹ì€ë°©ë²•ì¢€.. fs readfileì´ë¼ë„


https://ncs-rank-api-test.itemscout.io/tracking

```javascript
<% for (const mall of linksByMall) { %>
	<a href="mall.link"><%mall.mallName%></a>
<% } %>
```

ì¼ë‹¨ ê¸°ë³¸ê¸°ëŠ¥ì€ ë˜ì—ˆê³ .
ì²˜ìŒì— 


### GET /ncs/email/login
1. token, userId
- token ìœ íš¨í•œì§€ ì²´í¬, ìœ íš¨í•˜ë©´ email
- ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ throw Error
	- tokenì´ ì—†ìœ¼ë©´: ì¸ì¦ ë§í¬ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
	- ë§Œë£Œë˜ì—ˆìœ¼ë©´: 5ë¶„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤. ì´ë©”ì¼ ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.
- ìœ íš¨í•˜ë©´
	- users í…Œì´ë¸”ì—ì„œ userIdë¡œ ì¡°íšŒ, emailê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ì²´í¬
	- ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ throw Error: ì¸ì¦
	- ì¼ì¹˜í•˜ë©´ 
- ì¿ í‚¤ ë°œê¸‰
- ë¦¬ë‹¤ì´ë ‰íŠ¸ (í´ë¼ì´ì–¸íŠ¸ ì£¼ì†Œ)

        if (emailChange.expiresAt < new Date()) {
            throw new ExpiredEmailCodeError('Expired code');
        }

ì¿ í‚¤ëŠ” ì–¸ì œ ë°œê¸‰í•˜ëŠ”ê°€?
- ì„¸ì…˜ì„ ìƒì„±í•´ì„œ ë‹´ê³ ìˆì–´ì•¼í•˜ê³ ,
- 

ğŸŸ  cookie options, create session í•œêµ°ë°ë¡œ ëª¨ìœ¼ê¸°
ğŸ”´ ìŠ¤í† ì–´ ì—¬ëŸ¬ê°œë¡œ í•´ë³´ê¸°. -> ejsì— CSS ìˆ˜ì • ã„±.
ğŸ”´ ë„¤ì´ë²„ ë©”ì¼ ê¹¨ì§€ëŠ”ê²ƒ ìˆ˜ì •!

ğŸ”´ ì¶”ê°€:
dev
NCS_SERVER_API_URL="https://ncs-rank-api-test.itemscout.io/api"
prd
NCS_SERVER_API_URL="https://ncs-rank-api.itemscout.io/api"



https://smartstore.naver.com/i/v2/channels/2uvsTWIRDft1ldJZ2YJPK/products/10154132634?withWindow=false

---
## DB redundency ì œê±°

---
### ì¸ë±ìŠ¤ +ì¶”ê°€ ê³ ë ¤
ì´ë©”ì¼ ì¸ì¦, changeì—ì„œ expireAtì„ descë¡œ ë‘”ë‹¤ë˜ê°€,
ë‹¤ë¥¸ date í¬í•¨ í…Œì´ë¸”ë“¤ì— dateë¥¼ descë¡œ ì¸ë±ìŠ¤ë¥¼ ë‘”ë‹¤ë˜ê°€.

product daily
`@@unique([productId, date(sort: Desc), type])`

---
### ğŸ”´ğŸ”´  syncDate batch ì—ëŸ¬ë‚˜ê³  ìˆìŒ!!!

---
## ê´€ì‹¬  vs ë…¸ì¶œí‚¤ì›Œë“œ ì¤‘ë³µë°ì´í„° ì²˜ë¦¬
#### ğŸ’ tracked keywordsì—ì„œ exposed ì— ì—†ìœ¼ë©´ getByKeyword ì•ˆë¶€ë¥´ë„ë¡ í•˜ê¸°
-> trackedì™€ exposedì—ì„œ ë™ì‹œì— exposedë¥¼ ë¶€ë¥¼í…ë°
ì •ë§ë¡œ ì´ìƒì´ ì—†ì—ˆë‹¤.
await this.exposedKeywordsRepository.upsertMany(

`getExposedRankMapByNvMids()` í•¨ìˆ˜ì—ì„œ rank, productCntë¥¼ ê°€ì ¸ì˜¤ê²Œ ë˜ì–´ìˆê³ 
searchCntëŠ” ë³„ë„ë¡œ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— ì €ê²ƒë§Œ trackedì— ë¨¼ì € ë¶€ë¥´ë„ë¡ í–ˆë‹¤.

ë¡œê·¸ë¥¼ ë³´ë©´ 
- exposed keywords í…Œì´ë¸” ì—…ë°ì´íŠ¸ê°€ ê°™ì€ nvmidë¡œ ì¤‘ë³µë˜ì§€ ì•Šì•˜ê³ ,
- exposed í…Œì´ë¸”ë‚´ ìµœì‹ ë‚ ì§œê°€ ì—†ì–´ ìƒˆë¡œ ì¡°íšŒí•˜ê¸° ìœ„í•œ query/products ì¿¼ë¦¬ê°€ í•œë²ˆë°–ì— ì¼ì–´ë‚˜ì§€ ì•Šì•˜ë‹¤.
ì¦‰, tracked ë“  exposedë“  ë¨¼ì € `getExposedRankMapByNvMids()`ë¥¼ ì‹œì‘í•œ ì• ê°€
ì¿¼ë¦¬ì„œë²„ ìš”ì²­ ë° ì €ì¥í•œ í›„ ë‹¤ë¥¸ APIì—ì„œëŠ” selectì—ì„œ ê±¸ë ¤ë“ ë‹¤ëŠ” ëœ».

```
* ë…¸ì¶œí‚¤ì›Œë“œ ì—…ë°ì´íŠ¸
UPDATE `ncs_itemscout`.`product_exposed_keywords
1. ["29051081955","2024-07-16",{"keywords":[{"query":"ê°•ì•„ì§€ë§¤íŠ¸"
2. ["81979014311","2024-07-16",{"keywords":[{"query":"ê°•ì•„ì§€ë§¤íŠ¸"
3. ["11635255272","2024-07-16",{"keywords":[{"query":"ê°•ì•„ì§€ë§¤íŠ¸",
4. ["83267026929","2024-07-16",{"keywords":[{"query":"ê°•ì•„ì§€ë§¤íŠ¸",
5. ["82009299463","2024-07-16",{"keywords":[{"query":"ì• ê²¬ë¯¸ë„ëŸ¼ë°©ì§€ë§¤íŠ¸"
6. ["48446855704","2024-07-16",{"keywords":[{"query":"ì• ê²¬ë¯¸ë„ëŸ¼ë°©ì§€ë§¤íŠ¸"

* ì¹´í…Œê³ ë¦¬ë‚´ ìƒí’ˆ ìˆœìœ„ì¡°íšŒ
[NCS QUERY ENDED] query/category - CategoryId: 50006727, 1270ms
[NCS QUERY ENDED] query/category/productCount - CategoryId: 50006727, 860ms
[NCS QUERY ENDED] query/category - CategoryId: 50006727, 2050ms
[NCS QUERY ENDED] query/category - CategoryId: 50006727, 2349ms
[NCS QUERY ENDED] query/category - CategoryId: 50006727, 2948ms

[NCS QUERY ENDED] query/products - NvMids: 29051081955,17325741362,81979014311,11635255272,16387088557,83267026929,82009299463,87754945976,87992348778,48446855704,88066509132, 2030ms

```


ğŸŸ¢ğŸŸ¢ IP 10ê°œ ëœë¤ìœ¼ë¡œ proxy

---
## promise.allë¡œ query/keyword ìš”ì²­ ë°±ì—…
```typescript
            const newKeywords = Array.from(unSavedKeywordSet);

            const rankResult = await Promise.all(
                newKeywords.map(async (keyword) => {
                    // ê° í‚¤ì›Œë“œì—ì„œ í•´ë‹¹ ìƒí’ˆì˜ ìˆœìœ„ë¥¼ êµ¬í•œë‹¤
                    const { result, lastDateStr } =
                        await this.rankSearchAdapter.getByKeyword(
                            keyword,
                            undefined,
                            [nvMid],
                            2,
                        );
                    const includeStatusNone = true;
                    const rankInfo = await RankUtil.processRankData(
                        result,
                        lastDateStr,
                        includeStatusNone,
                    );
                    return { keyword, rankInfo, lastDateStr };
                }),
            );

            //ê²€ìƒ‰ê²°ê³¼ë‚´ productCntê°€ nullì¸ í‚¤ì›Œë“œë“¤ì„ í•„í„°ë§
            const keywordsToFetchProductCnt = rankResult
                .filter(
                    ({ rankInfo }) => rankInfo && rankInfo.productCnt === null,
                )
                .map(({ keyword }) => keyword);

            // í•„í„°ë§ëœ í‚¤ì›Œë“œë“¤ë§Œ productCnt í•œë²ˆì— ìš”ì²­
            const keywordProductCntMap =
                await this.getProductCntByMultipleKeywords(
                    keywordsToFetchProductCnt,
                    lastDate,
                );

            console.log('rankResult', rankResult);
            console.log('keywordProductCntMap', keywordProductCntMap);

            // keywordProductCntMapì„ rankResultsì— ë°˜ì˜
            for (const { keyword, rankInfo } of rankResult) {
                if (rankInfo) {
                    rankInfo.productCnt = keywordProductCntMap.get(keyword);
                    queryRankMap.set(keyword, rankInfo);
                }
            }
        }

        return queryRankMap;
```