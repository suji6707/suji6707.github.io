+++
title = 'CDN cache purge'
date = 2024-08-31T00:20:22+09:00
draft = true
+++
## Cloudflare CDN & Coreless Purge


Flexible purge: purge based on response type not the request
- 요청 기반 삭제: 일반적으로 캐시 삭제는 요청 URL, 헤더, 쿼리 파라미터 등 요청의 특성을 기반으로 이루어집니다. 
- 응답 기반 삭제: 이 방식에서는 요청이 아닌 응답의 특성, 예를 들어 응답의 콘텐츠 타입(JSON, HTML 등)이나 상태 코드 등을 기준으로 캐시를 삭제합니다.
  - 모든 JSON 형식의 응답을 캐시에서 삭제하고 싶을 때, 응답의 콘텐츠 타입이 JSON인 경우에만 캐시를 삭제합니다.
  - 응답을 기준으로 하기 때문에, 모든 캐시된 데이터를 열어봐야 하는 비효율성
  - 해당 응답이 오기 전까지는 그 JSON을 삭제하면 안되고, 따라서 '모든 JSON을 삭제하라'는 캐시 delete 요청을 저장해두고 있어야함.
  - 그리고 JSON 형태 응답들마다 TTL이 다른데 purge 요청이 온 이상 접근할 수 없어서? TTL이 다해 만료될때까지 삭제요청을 들고있어야한다 🤨

RocksDB의 LSM(Log-Structured Merge) 트리
- 데이터베이스의 쓰기 성능을 최적화하기 위해 설계된 데이터 구조
- 데이터는 먼저 메모리 내의 MemTable에 기록됩니다. 이는 빠른 쓰기를 가능하게 합니다.
- memTable이 가득 차면, 이를 디스크에 SSTable(Sorted String Table)이라는 불변의 파일로 플러시
- 디스크에 여러 SSTable이 쌓이면, 백그라운드에서 병합 작업이 수행됩니다. 이 과정에서 오래된 SSTable을 새로운 SSTable로 병합

B+트리와 가비지콜렉션
- B+ 트리는 데이터를 페이지 단위로 저장합니다.•데이터 삽입이나 수정 시, 해당 페이지를 디스크에 다시 쓰게 됩니다.
- SSD는 덮어쓰기가 불가능하며, 새 데이터를 쓸 때마다 새로운 물리적 위치에 기록합니다. 이전 데이터는 무효화되지만 물리적으로는 여전히 존재합니다.
- B+ 트리가 같은 페이지를 자주 업데이트하면, SSD는 매번 새로운 위치에 데이터를 쓰게 됩니다.
- 가비지콜렉션: 무효화된 데이터가 쌓이면 SSD의 사용 가능한 공간이 줄어듭니다.•GC는 이러한 무효화된 데이터를 정리하고 공간을 회수합니다. GC 과정은 I/O 성능에 부정적인 영향.

데이터베이스 시스템 삭제 작업과 Tombstone
- "Tombstone"은 데이터베이스에서 삭제된 레코드를 표시하는 특별한 마커
- LSM 트리 기반 데이터베이스(예: RocksDB)에서 데이터를 삭제할 때, 실제로 데이터를 즉시 제거하지 않고 tombstone을 생성. 이는 새로운 삽입 작업으로 취급됨.
- Cassandra와 같은 시스템에서 대량의 tombstone으로 인해 읽기 속도가 느려지기도 함.

Cash DB (새로운 데이터베이스)
- Rust로 작성되고 RocksDB 위에 구축된 새로운 데이터베이스 시스템. 활성 삭제(active purge) 방식을 사용하여 삭제 요청을 즉시 실행
- 캐시 조회 시 삭제 큐를 확인하여 아직 처리되지 않은 삭제 요청이 있는지 확인합니다.•이를 통해 캐시된 파일이 삭제 예정인 경우 원본 서버에서 새 복사본을 가져옵니다.

🍎 LST 인덱스
- LSM 트리 기반 시스템에서는 일반적으로 데이터의 위치를 가리키는 인덱스 구조를 유지. LSM 트리 구조 자체가 인덱스 역할. 실제 데이터와 별도로 관리됨. 
- 메모리 내 구조(MemTable)와 디스크 상의 SSTable들이 함께 전체 데이터셋에 대한 인덱스를 형성
- 데이터 삭제 시, 실제 디스크에서 즉시 삭제하지 않고 인덱스에서만 제거. ('Logical Delete')
- Index is source of truth.
  - 인덱스에서 제거된 데이터는 시스템에서 더 이상 접근할 수 없음. 디스크에는 남아있더라도 삭제된 것으로 간주. 
  - 실제 디스크에서의 삭제는 나중에 스케줄링하여 수행할 수 있음. 이로써 즉각적인 삭제 작업의 부하를 줄이는 것.

Coreless Purge의 효과
- 스토리지 공간 10배 절약
  - 즉각적인 삭제: 이전에는 콘텐츠가 만료되거나 lazy purge가 실행될 때까지 기다려야 했지만, 이제는 즉시 삭제가 가능하여 불필요한 데이터가 스토리지에 남아 있지 않습니다.
  - 불필요한 데이터가 제거되면서 캐시 히트 비율이 개선되고, 이는 원본 서버로의 요청을 줄임