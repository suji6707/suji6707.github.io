+++
title = 'Boot.dev'
date = 2024-12-28T00:20:22+09:00
draft = true
+++
# Refcounting GC 
CëŠ” ì§ì ‘ ê´€ë¦¬í•˜ì§€ë§Œ, ìë™ìœ¼ë¡œ í•´ì£¼ëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ë§Œë“¤ì–´ë³¸ë‹¤.


* 'ì‹¤ì œ êµ¬ì¡°ì²´ í¬ê¸°ë§Œí¼' ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ê³ , ê·¸ ë©”ëª¨ë¦¬ë¥¼ ë°˜í™˜í•˜ëŠ”ê±°ì„.  -> sizeof í¬ì¸í„°ê°€ ì•„ë‹ˆë¼ êµ¬ì¡°ì²´ ìì²´ì„.
- callocì´ í• ë‹¹ëœ ë©”ëª¨ë¦¬ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•  ë¿, ë°˜í™˜ëœ ë©”ëª¨ë¦¬ì£¼ì†ŒëŠ” NULLì´ ì•„ë‹Œ íŠ¹ì • ê°’ì„. 
`snek_object_t *obj = (snek_object_t*)calloc(1, sizeof(snek_object_t));`

* refcount decreaseë€ ë¬´ì—‡ì¸ê°€?
ê°ì²´ì˜ ê²½ìš° ìì‹ ì„ free í•˜ê¸° ì „ì— ê°ì²´ ì•ˆì— ì°¸ì¡°ëœ ê°ì²´ë“¤ì˜ count-- í•´ì•¼í•œë‹¤.
ì™œëƒë©´ ê·¸ ì°¸ì¡°ëœ ê°ì²´ë“¤ì´ ë‹¤ë¥¸ ê³³ì—ì„œ ë˜ ì°¸ì¡°ë˜ê³  ìˆì„ ìˆ˜ ìˆê¸°ì—.
refcount_dec ëŠ” count=0ì´ ë˜ë©´ í•´ì œí•œë‹¤.

* ê°ì²´ ë°°ì—´ ì›ì†Œì— íŠ¹ì • ê°’ ë„£ê¸°ğŸ’
elementëŠ” í¬ì¸í„°ì´ê¸° ë•Œë¬¸ì— ì—¬ê¸°ì— ë‹¤ë¥¸ ì£¼ì†Œë¥¼ ë„£ì–´ë´ì•¼ ë°°ì—´ ì¸ë±ìŠ¤ ì›ì†ŒëŠ” ë³€í•˜ì§€ ì•ŠìŒ.
```c
a,b,c,d,e -> ëª¨ë‘ í¬ì¸í„°. e Idxì— ì§ì ‘ value ë„£ì–´ì¤˜ì•¼
        |
       / \
   prev   newVal
refCount--  

snek_object_t *element = snek_obj->data.v_array.elements[index];
if (element != NULL) {
    refcount_dec(element);
}
// element = value;
snek_obj->data.v_array.elements[index] = value;
```

# Mark and Sweep GC
first, second ë°°ì—´ì´ ì„œë¡œë¥¼ ì°¸ì¡°í•˜ëŠ” ê²½ìš° 
refcount_dec ë§Œìœ¼ë¡œëŠ” freeê°€ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ.

-> MaS GCëŠ” ìˆœí™˜ ì°¸ì¡°ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
MaSëŠ” ì£¼ê¸°ì ìœ¼ë¡œ í•œ ë²ˆì— ì²˜ë¦¬í•˜ë¯€ë¡œ ì‹¤ì‹œê°„ ê´€ë¦¬ ë¶€ë‹´ì´ ì ìŒ.

### vm_track_object í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ "type-safe" í•˜ë‹¤?

* vm->object
VMì´ ê´€ë¦¬í•˜ëŠ” ëª¨ë“  ê°ì²´ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì¶”ì í•  ìˆ˜ 
ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ ì‹¤í–‰ë  ë•Œ, VMì€ vm->objectsì— ë“±ë¡ëœ ê°ì²´ë§Œ ê²€ì‚¬

* vm->frames
ê°€ìƒ ë¨¸ì‹ (VM)ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í•¨ìˆ˜ í˜¸ì¶œì´ë‚˜ ì½”ë“œ ë¸”ë¡ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬.
ê° frameì€ í•¨ìˆ˜ í˜¸ì¶œì´ë‚˜ ì½”ë“œ ë¸”ë¡ì˜ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì´ ì»¨í…ìŠ¤íŠ¸ëŠ” ì§€ì—­ ë³€ìˆ˜, ì„ì‹œ ê°ì²´, í•¨ìˆ˜ ì¸ì ë“±ì„ í¬í•¨.
frames ìŠ¤íƒì€ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¶”ì í•˜ì—¬ í•¨ìˆ˜ í˜¸ì¶œì´ ì¤‘ì²©ë  ë•Œ ì˜¬ë°”ë¥¸ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìœ ì§€
-> ê·¸ë˜ì„œ frames ìŠ¤íƒì˜ ê° data[i]ëŠ” ë˜ë‹¤ë¥¸ ìŠ¤íƒì„ ê°€ë¦¬í‚¤ëŠ” í”„ë ˆì„ì´ë‹¤(frame->referenceê°€ ìŠ¤íƒ)

vmì´ ëª¨ë“  ê°ì²´ë¥¼ íŠ¸ë˜í‚¹í•œë‹¤-
_new_snek_object()ëŠ” obj ìƒì„± í›„ vmì˜ objectsì— ê·¸ objë¥¼ ë„£ëŠ”ë‹¤. 
vm_track_object(): stack_push(vm->objects, obj);

ë„ë‹¬ ê°€ëŠ¥í•œ ëª¨ë“  ê°ì²´ë“¤ì„ ëŒë©´ì„œ mark, 
ë©”ëª¨ë¦¬ë¥¼ ìŠ¤ìº”í•˜ë©´ì„œ unmarked ê°ì²´ë“¤ì„ ê°€ë¹„ì§€ë¡œì„œ ìˆ˜ì§‘í•œë‹¤.
ê° ìŠ¤íƒí”„ë ˆì„ì—ì„œ ì°¸ì¡°ë˜ëŠ” ê°ì²´ë“¤ì„ íŠ¸ë˜í‚¹

---

root objectsì— ë§ˆí‚¹í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ë“¤.
objectsëŠ” ìŠ¤íƒí”„ë ˆì„ì— ì˜í•´ ì§ì ‘ì ìœ¼ë¡œ ì°¸ì¡°ë˜ëŠ”ë°

mark í•¨ìˆ˜ëŠ” 'vm->frames' ìŠ¤íƒì˜ ëª¨ë“  ì°¸ì¡°ë˜ëŠ” objì— mark í‘œì‹œë¥¼ í•œë‹¤. 

ì¦‰ ì²˜ìŒ new obj ìƒì„±ì‹œì—” is_marked = false,
ìŠ¤íƒí”„ë ˆì„ì— ë“¤ì–´ì˜¤ê³  ë‚˜ë©´ trueë¡œ. 

ë©”ëª¨ë¦¬ë¥¼ í•œë²ˆ sweep í•  ë•Œ markë¥¼ í•˜ê²Œëœë‹¤.

BUT ë¬¸ì œì .
- [a] -> listë§Œ ë§ˆí‚¹í•˜ê³  malloc obj í•˜ì§€ ì•Šì€ aëŠ” ë§ˆí‚¹ì•ˆí•¨.
- ìƒì„±í–ˆì§€ë§Œ ë¦¬í„´í•˜ì§€ ì•Šì€ ê°ì²´. -> ë§ˆí‚¹ì€ ëì§€ë§Œ ì“°ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ì—†ì• ì•¼ í•  ì¡´ì¬ì„

# Tracing
Tracingì´ ì´ê±¸ í•´ê²°í•¨.
tracingì€ mark and sweep ì¤‘ mark ë‹¨ê³„.
root objectì— ì˜í•´ ì°¸ì¡°ë˜ëŠ” ëª¨ë“  ê°ì²´ë¥¼ ë§ˆí‚¹í•˜ëŠ”.
- vm->objectsì˜ ëª¨ë“  markedëœ ê°ì²´ë“¤ì„ gray_objectsë¼ëŠ” ìŠ¤íƒì— ë‹´ì•„ í•˜ë‚˜ì”© êº¼ë‚´ë©´ì„œ ë§ˆí‚¹í•œë‹¤. 

int/float/stringì€ ì›ì‹œíƒ€ì…ì´ë¯€ë¡œ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ì§€ ì•ŠìŒ. -> tracing ì•ˆí•¨.
- stringì€ freeí•  ë•Œ char * ë©”ëª¨ë¦¬ëŠ” í•´ì œí•˜ì§€ë§Œ GC ëŒ€ìƒì€ ì•„ë‹ˆë‹¤?


## ë§ˆí‚¹ì‹œ ê·¸ë˜í”„ íƒìƒ‰ ì•Œê³ ë¦¬ì¦˜
Q. GC êµ¬í˜„ì—ì„œ vm->objectsì˜ ëª¨ë“  markedëœ ê°ì²´ë“¤ì„ gray_objectsë¼ëŠ” ìŠ¤íƒì— ë‹´ì•„ í•˜ë‚˜ì”© êº¼ë‚´ë©´ì„œ ë§ˆí‚¹í•˜ë„ë¡ í•˜ëŠ”ë°, ì™œ ì´ë¯¸ ë§ˆí‚¹ëœê²ƒì„ ìŠ¤íƒì— ë‹´ê³ , ê±°ê¸°ì„œ ë§ˆí‚¹ì´ ì•ˆëœê±¸ ë§ˆí‚¹í•˜ëŠ”ê±°ì§€? ì• ì´ˆì— ë§ˆí‚¹ëœê²ƒë§Œ ë‹´ì€ê±° ì•„ë‹Œê°€

##### ë§ˆí‚¹ë˜ì§€ ì•Šì€ ê²ƒë“¤ì„ ë§ˆí‚¹í•˜ëŠ” ê³¼ì •
-> is_marked = falseì¸ê²Œ ìˆë‚˜?
```c
void trace(vm_t *vm) {
  stack_t *gray_objects = stack_new(8);

  // ë§ˆí‚¹ëœ ëª¨ë“  objectsë¥¼ gray ìŠ¤íƒì— ë‹´ëŠ”ë‹¤(íšŒìƒ‰ ìƒíƒœë¡œ)
  for (int i = 0; i < vm->objects->count; i++) {
    snek_object_t *obj = vm->objects->data[i];
    if (obj->is_marked) {
      stack_push(gray_objects, obj);
    }
  }
  // gray ìŠ¤íƒì˜ ëª¨ë“  ê°ì²´ê°€ ì°¸ì¡°í•˜ëŠ” ê°ì²´ë“¤ë„ ë§ˆí‚¹í•œë‹¤(íšŒìƒ‰ ìƒíƒœë¡œ)
  while (gray_objects->count > 0) {
    snek_object_t* obj = (snek_object_t*)stack_pop(gray_objects);
    trace_blacken_object(gray_objects, obj);
  }
  // gray ìŠ¤íƒ ê°ì²´ë“¤ì€ ê²€ì€ìƒ‰ ìƒíƒœê°€ ëœë‹¤. (neighboring all marked) 
  stack_free(gray_objects);
}
```

ì´ ì½”ë“œì—ì„œ `gray_objects` ìŠ¤íƒì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” Mark-and-Sweep ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ì˜ "ì‚¼ìƒ‰ ë§ˆí‚¹" ì•Œê³ ë¦¬ì¦˜ê³¼ ê´€ë ¨ì´ ìˆìŠµë‹ˆë‹¤. ì´ ì•Œê³ ë¦¬ì¦˜ì€ ê°ì²´ë¥¼ ì„¸ ê°€ì§€ ìƒ‰ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì²˜ë¦¬í•©ë‹ˆë‹¤: í°ìƒ‰, íšŒìƒ‰, ê²€ì€ìƒ‰. ê° ìƒ‰ì€ ê°ì²´ì˜ ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

1. **í°ìƒ‰ (White)**: ì•„ì§ ë°©ë¬¸ë˜ì§€ ì•Šì€ ê°ì²´.
2. **íšŒìƒ‰ (Gray)**: ë°©ë¬¸ì€ ë˜ì—ˆì§€ë§Œ, ê·¸ ê°ì²´ê°€ ì°¸ì¡°í•˜ëŠ” ë‹¤ë¥¸ ê°ì²´ë“¤ì€ ì•„ì§ ëª¨ë‘ ë°©ë¬¸ë˜ì§€ ì•Šì€ ìƒíƒœ.
3. **ê²€ì€ìƒ‰ (Black)**: ê°ì²´ì™€ ê·¸ ê°ì²´ê°€ ì°¸ì¡°í•˜ëŠ” ëª¨ë“  ê°ì²´ê°€ ë°©ë¬¸ëœ ìƒíƒœ.

ì´ ì•Œê³ ë¦¬ì¦˜ì˜ í•µì‹¬ì€ íšŒìƒ‰ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì²´ ê·¸ë˜í”„ë¥¼ íƒìƒ‰í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. íšŒìƒ‰ ê°ì²´ëŠ” ì•„ì§ ì™„ì „íˆ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—, ì´ë“¤ì„ ì¶”ì í•˜ì—¬ ëª¨ë“  ì—°ê²°ëœ ê°ì²´ë¥¼ ë°©ë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê³¼ì • ì„¤ëª…

1. **ì´ˆê¸° ë§ˆí‚¹**: `mark` í•¨ìˆ˜ëŠ” ë£¨íŠ¸ ì§‘í•©ì—ì„œ ì‹œì‘í•˜ì—¬ ì§ì ‘ ì°¸ì¡°ë˜ëŠ” ê°ì²´ë“¤ì„ ë§ˆí‚¹í•©ë‹ˆë‹¤. ì´ ë‹¨ê³„ì—ì„œëŠ” ê°ì²´ê°€ íšŒìƒ‰ ìƒíƒœê°€ ë©ë‹ˆë‹¤.

2. **íšŒìƒ‰ ê°ì²´ ì²˜ë¦¬**: `trace` í•¨ìˆ˜ëŠ” íšŒìƒ‰ ê°ì²´ë¥¼ `gray_objects` ìŠ¤íƒì— ë„£ê³ , ì´ ìŠ¤íƒì„ í†µí•´ ê°ì²´ ê·¸ë˜í”„ë¥¼ íƒìƒ‰í•©ë‹ˆë‹¤. `trace_blacken_object` í•¨ìˆ˜ëŠ” íšŒìƒ‰ ê°ì²´ë¥¼ ì²˜ë¦¬í•˜ì—¬ ê·¸ ê°ì²´ê°€ ì°¸ì¡°í•˜ëŠ” ë‹¤ë¥¸ ê°ì²´ë“¤ì„ ë§ˆí‚¹í•˜ê³ , ì´ë“¤ì„ ë‹¤ì‹œ íšŒìƒ‰ìœ¼ë¡œ ë§Œë“¤ì–´ `gray_objects` ìŠ¤íƒì— ì¶”ê°€í•©ë‹ˆë‹¤.

3. **ê²€ì€ìƒ‰ìœ¼ë¡œ ë³€í™˜**: `trace_blacken_object`ê°€ ì™„ë£Œë˜ë©´, í•´ë‹¹ ê°ì²´ëŠ” ê²€ì€ìƒ‰ì´ ë©ë‹ˆë‹¤. ì¦‰, ê·¸ ê°ì²´ì™€ ê·¸ ê°ì²´ê°€ ì°¸ì¡°í•˜ëŠ” ëª¨ë“  ê°ì²´ê°€ ë°©ë¬¸ëœ ìƒíƒœê°€ ë©ë‹ˆë‹¤.

### ì™œ ì´ë¯¸ ë§ˆí‚¹ëœ ê°ì²´ë¥¼ ìŠ¤íƒì— ë„£ëŠ”ê°€?

- **ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰**: ì´ë¯¸ ë§ˆí‚¹ëœ ê°ì²´ëŠ” íšŒìƒ‰ ìƒíƒœë¡œ, ê·¸ ê°ì²´ê°€ ì°¸ì¡°í•˜ëŠ” ë‹¤ë¥¸ ê°ì²´ë“¤ì„ íƒìƒ‰í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ìƒˆë¡œìš´ ê°ì²´ê°€ ë°œê²¬ë˜ë©´, ê·¸ ê°ì²´ë¥¼ íšŒìƒ‰ìœ¼ë¡œ ë§Œë“¤ì–´ ìŠ¤íƒì— ì¶”ê°€í•©ë‹ˆë‹¤.
- **ì¬ê·€ì  íƒìƒ‰ ë°©ì§€**: ìŠ¤íƒì„ ì‚¬ìš©í•˜ì—¬ ëª…ì‹œì ìœ¼ë¡œ ê°ì²´ë¥¼ ì¶”ì í•¨ìœ¼ë¡œì¨, ì¬ê·€ì  í˜¸ì¶œ ì—†ì´ ê°ì²´ ê·¸ë˜í”„ë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ìŠ¤íƒ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë°©ì§€í•˜ê³ , íƒìƒ‰ ê³¼ì •ì„ ëª…í™•í•˜ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ, `gray_objects` ìŠ¤íƒì€ ê°ì²´ ê·¸ë˜í”„ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ íƒìƒ‰í•˜ê³ , ëª¨ë“  ë„ë‹¬ ê°€ëŠ¥í•œ ê°ì²´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë§ˆí‚¹í•˜ëŠ” ë° ì¤‘ìš”í•œ ì—­í• ì„ í•©ë‹ˆë‹¤.

---
# Sweeping

ì´ì œ ëª¨ë“  ê°ì²´ê°€ is_markedë¥¼ ê°–ê²Œ ë˜ì—ˆë‹¤. 
reachable í•œì§€ íŒë‹¨í•  ìˆ˜ ìˆë‹¤.

ë‹¨ ë§ˆí‚¹ëœ ëª¨ë“  ê°ì²´ëŠ” is_marked = falseë¡œ ë¦¬ì…‹ë˜ì–´ì•¼
ë‹¤ìŒë²ˆ mark phaseê°€ ëŒ ë•Œ - ë‹¤ì‹œ ë§ˆí‚¹ë˜ì§€ ì•Šìœ¼ë©´ ì°¸ì¡°ë˜ì§€ ì•ŠëŠ” ê²ƒìœ¼ë¡œ freeí•  ìˆ˜ ìˆë‹¤. 

#### ì „ì²´ ê³¼ì •**
```c
void vm_collect_garbage(vm_t *vm) {
  // í˜„ì¬ ìƒíƒœ: ìŠ¤íƒí”„ë ˆì„ì—ì„œ ì°¸ì¡°í•˜ëŠ” ëª¨ë“  ê°ì²´ ë§ˆí‚¹ -> gray
  mark(vm);
  // ê·¸ë˜í”„: ê·¸ ê°ì²´ë“¤ì´ ì°¸ì¡°í•˜ëŠ” ê°ì²´ë“¤ë„ ë§ˆí‚¹ -> black
  trace(vm);
  // ëª¨ë“  objects ëŒë©´ì„œ ë§ˆí‚¹ëœ ê²ƒì€ ì´ˆê¸°í™”, ì•ˆëœê²ƒì€ ì œê±°
  sweep(vm);
}
```

---

`&obj->data.v_array` vs `obj->data.v_array`
1.obj->data.v_array: êµ¬ì¡°ì²´ ê°’ ìì²´
2.&(obj->data.v_array): êµ¬ì¡°ì²´ì˜ ì£¼ì†Œ

v_arrayê°€ *ê°€ ì•„ë‹Œ êµ¬ì¡°ì²´ë¡œ ì €ì¥ë˜ì–´ìˆê¸° ë•Œë¬¸ì—,
í¬ì¸í„°ë¡œ ì ‘ê·¼í•˜ë ¤ë©´ 2ë²ˆìœ¼ë¡œ í•´ì•¼.
```c
typedef union SnekObjectData {
  snek_array_t v_array;
} snek_object_data_t;

snek_array_t *array = &obj->data.v_array;
```
